<!doctype html>
<html lang="pt-BR" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Treinos + Timer</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<link rel="icon" href="icons/icon-192.png">

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      colors: { pinkshock: '#ff2d8d' }
    }
  }
}
</script>
</head>

<body class="bg-slate-950 text-slate-100 pb-24">

<div class="max-w-xl mx-auto p-4">

<!-- HOME -->
<section id="telaHome">
  <h1 class="text-2xl font-semibold mb-6">Meus treinos</h1>
  <div id="listaTreinos"></div>

  <button id="btnNovo"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock">
    + Novo treino
  </button>
</section>

<!-- CADASTRAR -->
<section id="telaCadastrar" class="hidden">
  <h1 class="text-2xl font-semibold mb-6">Novo treino</h1>

  <label class="text-xs text-slate-400">Nome do treino</label>
  <input id="inputNome"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mb-3 mt-1"
    placeholder="Treino 1" />

  <label class="text-xs text-slate-400">Descri√ß√£o (tipo do treino)</label>
  <input id="inputDescricao"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mb-3 mt-1"
    placeholder="Perna, Bra√ßo, Costas + b√≠ceps..." />

  <div class="grid grid-cols-2 gap-3 mb-3">
    <div>
      <label class="text-xs text-slate-400">Data de in√≠cio (opcional)</label>
      <input id="inputInicio"
        type="date"
        class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mt-1" />
    </div>
    <div>
      <label class="text-xs text-slate-400">Data final (opcional)</label>
      <input id="inputFim"
        type="date"
        class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mt-1" />
    </div>
  </div>

  <label class="text-xs text-slate-400">Exerc√≠cios</label>
  <textarea id="inputRaw"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 min-h-[160px] mt-1"
    placeholder="Agachamento | 2x10 | descanso 60"></textarea>

  <div class="flex gap-2 mt-3">
    <button id="btnSalvar"
      class="flex-1 rounded-xl px-4 py-2 bg-pinkshock">
      Salvar
    </button>
    <button id="btnCancelar"
      class="rounded-xl px-4 py-2 bg-slate-800">
      Cancelar
    </button>
  </div>

  <div class="mt-4 p-3 rounded-xl border border-slate-800 bg-slate-900/40">
    <div class="text-xs text-slate-400 leading-relaxed">
      Formato por linha (sem adivinha√ß√£o):
      <div class="mt-2 text-slate-200">Exerc√≠cio | 2x10 | descanso 60</div>
      <div class="mt-2">
        ‚Ä¢ S√©ries e reps precisam estar em NxM (ex: 2x10)<br>
        ‚Ä¢ Se n√£o informar descanso, fica ‚Äúsem descanso definido‚Äù<br>
        ‚Ä¢ Se definir data final, o treino ser√° apagado automaticamente ap√≥s essa data
      </div>
    </div>
  </div>
</section>

<!-- VISUALIZA√á√ÉO -->
<section id="telaVisualizar" class="hidden">
  <button id="btnVoltarHome" class="text-sm text-pinkshock mb-4">‚Üê Voltar</button>

  <h1 id="tituloTreino" class="text-2xl font-semibold"></h1>
  <div id="subtituloTreino" class="text-sm text-slate-400 mt-1 mb-3"></div>

  <div class="text-xs text-slate-400 mb-2 flex justify-between">
    <span>exerc√≠cio</span>
    <span>s√©ries ‚Ä¢ reps ‚Ä¢ descanso</span>
  </div>

  <div id="listaExerciciosVisual" class="border border-slate-800 rounded-xl overflow-hidden"></div>

  <button id="btnIniciar"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-green-600 font-semibold">
    INICIAR
  </button>
</section>

<!-- EXECU√á√ÉO -->
<section id="telaExecucao" class="hidden">

  <div class="sticky top-0 bg-slate-950 pt-4 pb-3 mb-4 border-b border-slate-800 z-10">
    <div class="text-center">
      <div class="text-sm text-slate-400">Cron√¥metro do treino</div>
      <div id="timerTotal" class="text-5xl font-extrabold text-pinkshock tracking-tight">00:00</div>
    </div>

    <div id="boxDescanso" class="hidden mt-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-400">descanso</div>
          <div class="flex items-baseline gap-2">
            <div id="timerDescanso" class="text-2xl font-bold text-slate-100">00:00</div>
            <div id="descansoMeta" class="text-sm text-slate-400">de 00:00</div>
          </div>
        </div>

        <button id="btnPularDescanso"
          class="shrink-0 rounded-xl px-3 py-2 bg-pinkshock text-sm font-semibold">
          Pular
        </button>
      </div>

      <div class="mt-3">
        <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
          <div id="barraDescanso" class="h-full bg-pinkshock w-0"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-xs text-slate-400 mb-2 flex justify-between">
    <span>exerc√≠cio</span>
    <span>s√©ries</span>
  </div>
  <div id="listaExerciciosExec" class="border border-slate-800 rounded-xl overflow-hidden"></div>

  <button id="btnFinalizar"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock font-semibold">
    Finalizar treino
  </button>

</section>

<!-- RESUMO FINAL -->
<section id="telaResumo" class="hidden">
  <h1 class="text-2xl font-semibold mb-4">Resumo do treino</h1>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
    <div class="text-sm text-slate-400">Dura√ß√£o</div>
    <div id="resumoDuracao" class="text-4xl font-extrabold text-pinkshock mt-1">00:00</div>

    <div class="mt-4 grid grid-cols-2 gap-3">
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
        <div class="text-xs text-slate-400">In√≠cio</div>
        <div id="resumoInicio" class="text-sm font-semibold text-slate-200 mt-1">‚Äî</div>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
        <div class="text-xs text-slate-400">Fim</div>
        <div id="resumoFim" class="text-sm font-semibold text-slate-200 mt-1">‚Äî</div>
      </div>
    </div>

    <div class="mt-3 text-xs text-slate-400">
      <span id="resumoData">‚Äî</span>
    </div>
  </div>

  <button id="btnVoltarResumo"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock font-semibold">
    Voltar para Home
  </button>
</section>

</div>

<nav class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800">
  <div class="max-w-xl mx-auto flex">
    <button id="navHome"
      class="flex-1 py-3 text-sm font-medium text-pinkshock">
      üè† Home
    </button>
    <button id="navBackup"
      class="flex-1 py-3 text-sm font-medium text-slate-400">
      üíæ Backup
    </button>
  </div>
</nav>

<script>
/* =========================
   CONFIG / ESTADO
========================= */
const KEY = "treinos_app_final_v2";
let treinoAtual = null;
let treinoAtualIndex = null;

let totalInterval = null;
let descansoInterval = null;

let totalSegundos = 0;
let treinoInicioMs = null;

let descansoSegundos = 0;
let descansoTotal = 0;

/* =========================
   HELPERS
========================= */
function formatar(seg){
  const m = String(Math.floor(seg/60)).padStart(2,"0");
  const s = String(seg%60).padStart(2,"0");
  return `${m}:${s}`;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatarDataHora(ms){
  const d = new Date(ms);
  const dia = pad2(d.getDate());
  const mes = pad2(d.getMonth()+1);
  const ano = d.getFullYear();
  const hh = pad2(d.getHours());
  const mm = pad2(d.getMinutes());
  return { data: `${dia}/${mes}/${ano}`, hora: `${hh}:${mm}` };
}
function formatarDataISOparaBR(iso){
  if(!iso) return null;
  const [y,m,d] = iso.split("-");
  if(!y || !m || !d) return null;
  return `${d}/${m}/${y}`;
}
function agoraMs(){ return Date.now(); }
function inicioDoDiaMs(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.getTime();
}
function fimDoDiaMsFromISO(iso){
  // considera a data final como v√°lida at√© 23:59:59.999
  const d = new Date(iso + "T23:59:59.999");
  return d.getTime();
}
function setNav(ativo){
  const home = document.getElementById("navHome");
  const backup = document.getElementById("navBackup");

  if(ativo === "home"){
    home.classList.remove("text-slate-400");
    home.classList.add("text-pinkshock");
    backup.classList.remove("text-pinkshock");
    backup.classList.add("text-slate-400");
  } else {
    backup.classList.remove("text-slate-400");
    backup.classList.add("text-pinkshock");
    home.classList.remove("text-pinkshock");
    home.classList.add("text-slate-400");
  }
}

/* =========================
   TIMERS
========================= */
function iniciarCronometroTreino(){
  clearInterval(totalInterval);
  totalSegundos = 0;
  document.getElementById("timerTotal").textContent = "00:00";

  totalInterval = setInterval(()=>{
    totalSegundos++;
    document.getElementById("timerTotal").textContent = formatar(totalSegundos);
  },1000);
}

function atualizarUI_Descanso(){
  const box = document.getElementById("boxDescanso");
  const timer = document.getElementById("timerDescanso");
  const meta = document.getElementById("descansoMeta");
  const barra = document.getElementById("barraDescanso");

  if(descansoSegundos > 0){
    box.classList.remove("hidden");
    timer.textContent = formatar(descansoSegundos);
    meta.textContent = `de ${formatar(descansoTotal)}`;

    const pct = Math.max(0, Math.min(100, Math.round(((descansoTotal - descansoSegundos) / descansoTotal) * 100)));
    barra.style.width = pct + "%";
  } else {
    box.classList.add("hidden");
    timer.textContent = "00:00";
    meta.textContent = "de 00:00";
    barra.style.width = "0%";
  }
}

function iniciarDescanso(seg){
  const s = Number(seg);
  if(!Number.isFinite(s) || s <= 0) return;

  clearInterval(descansoInterval);
  descansoTotal = Math.floor(s);
  descansoSegundos = descansoTotal;

  atualizarUI_Descanso();

  descansoInterval = setInterval(()=>{
    descansoSegundos--;
    atualizarUI_Descanso();

    if(descansoSegundos <= 0){
      clearInterval(descansoInterval);
      descansoSegundos = 0;
      atualizarUI_Descanso();
      navigator.vibrate?.(200);
    }
  },1000);
}

function pularDescanso(){
  clearInterval(descansoInterval);
  descansoSegundos = 0;
  descansoTotal = 0;
  atualizarUI_Descanso();
}

/* =========================
   STORAGE
========================= */
function getTreinos(){
  return JSON.parse(localStorage.getItem(KEY) || "[]");
}
function setTreinos(data){
  localStorage.setItem(KEY, JSON.stringify(data));
}

function normalizarTreinos(treinos){
  treinos.forEach(t=>{
    if(!t.stats || typeof t.stats !== "object"){
      t.stats = { feitos: 0, ultimaVezMs: null };
    } else {
      if(typeof t.stats.feitos !== "number") t.stats.feitos = 0;
      if(typeof t.stats.ultimaVezMs === "undefined") t.stats.ultimaVezMs = null;
    }

    if(typeof t.descricao === "undefined") t.descricao = "";

    if(typeof t.periodo !== "object" || t.periodo === null){
      t.periodo = { inicio: null, fim: null }; // ISO YYYY-MM-DD
    } else {
      if(typeof t.periodo.inicio === "undefined") t.periodo.inicio = null;
      if(typeof t.periodo.fim === "undefined") t.periodo.fim = null;
    }

    if(t.lastSession && typeof t.lastSession !== "object"){
      t.lastSession = null;
    }
  });
  return treinos;
}

function removerTreinosExpirados(treinos){
  // remove treinos cuja data final j√° passou
  const hoje0 = inicioDoDiaMs();
  const antes = treinos.length;

  const filtrados = treinos.filter(t=>{
    const fim = t?.periodo?.fim;
    if(!fim) return true; // sem data final: n√£o expira
    const fimMs = fimDoDiaMsFromISO(fim);
    return hoje0 <= fimMs; // mant√©m at√© o fim do dia final
  });

  const removidos = antes - filtrados.length;
  return { filtrados, removidos };
}

/* =========================
   PARSER (SEM ADIVINHA√á√ÉO)
========================= */
function parseLinhas(raw){
  return raw
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean)
    .map(l=>{
      const partes = l.split("|").map(p=>p.trim());

      const nome = partes[0] || "Exerc√≠cio";
      const sr = (partes[1] || "").match(/^\s*(\d+)\s*x\s*(\d+)\s*$/i);
      const dm = (partes[2] || "").match(/(\d+)/);

      const series = sr ? Number(sr[1]) : null;
      const reps  = sr ? Number(sr[2]) : null;
      const descanso = dm ? Number(dm[1]) : null;

      return { nome, series, reps, descanso, feitas: 0 };
    });
}

/* =========================
   RENDER
========================= */
function renderHome(){
  let treinos = normalizarTreinos(getTreinos());

  const res = removerTreinosExpirados(treinos);
  treinos = res.filtrados;
  setTreinos(treinos);

  const host = document.getElementById("listaTreinos");
  host.innerHTML="";

  if(!treinos.length){
    host.innerHTML="<p class='text-slate-400'>Nenhum treino criado.</p>";
    return;
  }

  treinos.forEach((t,i)=>{
    const feitos = t.stats?.feitos ?? 0;
    const ultima = t.stats?.ultimaVezMs ? formatarDataHora(t.stats.ultimaVezMs) : null;

    const desc = (t.descricao || "").trim();
    const periodoIni = t?.periodo?.inicio ? formatarDataISOparaBR(t.periodo.inicio) : null;
    const periodoFim = t?.periodo?.fim ? formatarDataISOparaBR(t.periodo.fim) : null;

    const periodoTxt = (periodoIni || periodoFim)
      ? `${periodoIni ?? "‚Äî"} ‚Üí ${periodoFim ?? "‚Äî"}`
      : null;

    host.innerHTML+=`
      <div class="bg-slate-900 p-3 rounded-xl mb-3 border border-slate-800">
        <div class="flex justify-between items-start gap-3">
          <div class="min-w-0">
            <div class="font-medium truncate">${t.nome}</div>
            ${desc ? `<div class="text-xs text-slate-300 mt-1">${desc}</div>` : ``}
            <div class="text-xs text-slate-400 mt-1">
              feito <span class="text-slate-200 font-semibold">${feitos}</span> vez(es)
              ${ultima ? `‚Ä¢ √∫ltima: <span class="text-slate-200">${ultima.data}</span>` : `‚Ä¢ √∫ltima: ‚Äî`}
              ${periodoTxt ? `<br><span class="text-slate-500">per√≠odo:</span> <span class="text-slate-200">${periodoTxt}</span>` : ``}
            </div>
          </div>
          <button onclick="abrirTreino(${i})" class="text-pinkshock text-sm font-semibold shrink-0">Ver</button>
        </div>
      </div>
    `;
  });
}

function abrirTreino(i){
  let treinos = normalizarTreinos(getTreinos());

  // limpa expirados antes de abrir (pra n√£o abrir algo que j√° devia ter sumido)
  const res = removerTreinosExpirados(treinos);
  treinos = res.filtrados;
  setTreinos(treinos);

  treinoAtualIndex = i;
  treinoAtual = treinos[i];

  if(!treinoAtual){
    renderHome();
    mostrar("telaHome");
    return;
  }

  (treinoAtual.exercicios || []).forEach(e=>{
    if(typeof e.series === "undefined") e.series = null;
    if(typeof e.reps === "undefined") e.reps = null;
    if(typeof e.descanso === "undefined") e.descanso = null;
    if(typeof e.feitas !== "number") e.feitas = 0;
  });

  document.getElementById("tituloTreino").textContent = treinoAtual.nome;

  const desc = (treinoAtual.descricao || "").trim();
  const periodoIni = treinoAtual?.periodo?.inicio ? formatarDataISOparaBR(treinoAtual.periodo.inicio) : null;
  const periodoFim = treinoAtual?.periodo?.fim ? formatarDataISOparaBR(treinoAtual.periodo.fim) : null;
  const periodoTxt = (periodoIni || periodoFim) ? `Per√≠odo: ${periodoIni ?? "‚Äî"} ‚Üí ${periodoFim ?? "‚Äî"}` : "";

  const sub = [
    desc ? desc : null,
    periodoTxt ? periodoTxt : null
  ].filter(Boolean).join(" ‚Ä¢ ");

  document.getElementById("subtituloTreino").textContent = sub || "";

  mostrar("telaVisualizar");
  renderVisual();
}

function renderVisual(){
  const host = document.getElementById("listaExerciciosVisual");
  host.innerHTML="";

  const exs = (treinoAtual.exercicios || []);
  if(!exs.length){
    host.innerHTML = `<div class="p-3 text-slate-400">Sem exerc√≠cios.</div>`;
    return;
  }

  exs.forEach((e, idx)=>{
    const borda = idx === 0 ? "" : " border-t border-slate-800";
    const seriesTxt = (e.series && e.reps) ? `${e.series}` : "‚Äî";
    const repsTxt = (e.series && e.reps) ? `${e.reps}` : "‚Äî";
    const descansoTxt = (e.descanso || e.descanso === 0) ? `${e.descanso ?? "‚Äî"}s` : "‚Äî";

    const invalido = (!e.series || !e.reps);
    const badge = invalido
      ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-red-500/15 text-red-300 border border-red-500/25">corrigir 2x10</span>`
      : ``;

    host.innerHTML += `
      <div class="flex items-center justify-between gap-3 px-3 py-3 bg-slate-900${borda}">
        <div class="min-w-0">
          <div class="font-medium truncate">${e.nome}${badge}</div>
          <div class="text-xs text-slate-500">${e.descanso ? `descanso ${e.descanso}s` : `sem descanso definido`}</div>
        </div>
        <div class="text-right text-sm text-slate-200 shrink-0">
          <span class="text-slate-300">${seriesTxt}</span>
          <span class="text-slate-500"> ‚Ä¢ </span>
          <span class="text-slate-300">${repsTxt}</span>
          <span class="text-slate-500"> ‚Ä¢ </span>
          <span class="text-slate-300">${descansoTxt}</span>
        </div>
      </div>
    `;
  });
}

function iniciarExecucao(){
  treinoInicioMs = agoraMs();
  iniciarCronometroTreino();
  pularDescanso();

  mostrar("telaExecucao");
  renderExecucao();
}

function renderExecucao(){
  const host = document.getElementById("listaExerciciosExec");
  host.innerHTML="";

  const exs = (treinoAtual.exercicios || []);
  if(!exs.length){
    host.innerHTML = `<div class="p-3 text-slate-400">Sem exerc√≠cios.</div>`;
    return;
  }

  exs.forEach((e, i)=>{
    const invalido = (!e.series || !e.reps);
    const seriesNum = invalido ? 0 : e.series;

    const concluido = (!invalido && e.feitas >= e.series);
    const sub = invalido
      ? `defina s√©ries e reps no cadastro (ex: 2x10)`
      : `${e.series}x${e.reps} ‚Ä¢ ${e.descanso ? `descanso ${e.descanso}s` : `sem descanso definido`}`;

    const bolinhas = seriesNum > 0
      ? Array.from({length: seriesNum}).map((_, idx)=>{
          const n = idx + 1;
          const feita = n <= e.feitas;
          const base = "w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold border";
          const cls = feita
            ? "bg-pinkshock border-pinkshock text-white"
            : "bg-slate-950 border-slate-700 text-slate-300";
          return `
            <button
              class="${base} ${cls}"
              onclick="marcarSerieEmIndice(${i}, ${n})"
              aria-label="S√©rie ${n}">
              ${n}
            </button>
          `;
        }).join("")
      : `<span class="text-xs text-red-300">inv√°lido</span>`;

    const borda = i === 0 ? "" : " border-t border-slate-800";

    host.innerHTML += `
      <div class="flex items-center justify-between gap-3 px-3 py-3 bg-slate-900${borda}">
        <div class="min-w-0">
          <div class="font-medium truncate">
            ${e.nome}
            ${concluido ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-green-500/15 text-green-300 border border-green-500/25">conclu√≠do</span>` : ``}
          </div>
          <div class="text-xs ${invalido ? "text-red-300" : "text-slate-500"}">${sub}</div>
        </div>
        <div class="shrink-0 flex gap-2 flex-wrap justify-end">
          ${bolinhas}
        </div>
      </div>
    `;
  });
}

/* =========================
   A√á√ïES
========================= */
function marcarSerieEmIndice(exIdx, serieNumero){
  const e = treinoAtual.exercicios[exIdx];

  if(!e.series || !e.reps){
    alert("Esse exerc√≠cio est√° inv√°lido. Volte e corrija o formato (ex: 2x10).");
    return;
  }

  const feitasAntes = e.feitas;

  // desmarcar (voltar)
  if(serieNumero <= e.feitas){
    e.feitas = Math.max(0, serieNumero - 1);
    renderExecucao();
    return;
  }

  // marcar pra frente
  e.feitas = Math.min(e.series, serieNumero);

  const feitasDepois = e.feitas;

  // descanso s√≥ quando avan√ßa e ainda N√ÉO concluiu o exerc√≠cio
  const avancou = feitasDepois > feitasAntes;
  const concluiuExercicio = feitasDepois >= e.series;

  if(concluiuExercicio){
    pularDescanso();
  } else if(avancou && e.descanso){
    iniciarDescanso(e.descanso);
  }

  renderExecucao();
}

function abrirResumo(inicioMs, fimMs, duracaoSeg){
  const ini = formatarDataHora(inicioMs);
  const fim = formatarDataHora(fimMs);

  document.getElementById("resumoDuracao").textContent = formatar(duracaoSeg);
  document.getElementById("resumoInicio").textContent = ini.hora;
  document.getElementById("resumoFim").textContent = fim.hora;

  if(ini.data === fim.data){
    document.getElementById("resumoData").textContent = `Data: ${ini.data}`;
  } else {
    document.getElementById("resumoData").textContent = `In√≠cio: ${ini.data} ‚Ä¢ Fim: ${fim.data}`;
  }

  mostrar("telaResumo");
}

function finalizar(){
  clearInterval(totalInterval);
  clearInterval(descansoInterval);
  pularDescanso();

  const fimMs = agoraMs();
  const inicioMs = treinoInicioMs ?? (fimMs - (totalSegundos * 1000));
  const duracaoSeg = totalSegundos;

  let treinos = normalizarTreinos(getTreinos());

  // limpa expirados antes de gravar (seguran√ßa extra)
  const res = removerTreinosExpirados(treinos);
  treinos = res.filtrados;

  if(typeof treinoAtualIndex === "number" && treinos[treinoAtualIndex]){
    treinos[treinoAtualIndex].stats.feitos = (treinos[treinoAtualIndex].stats.feitos || 0) + 1;
    treinos[treinoAtualIndex].stats.ultimaVezMs = fimMs;
    treinos[treinoAtualIndex].lastSession = { inicioMs, fimMs, duracaoSeg };
  }

  setTreinos(treinos);

  (treinoAtual.exercicios || []).forEach(e=>e.feitas=0);

  abrirResumo(inicioMs, fimMs, duracaoSeg);
}

/* =========================
   SPA
========================= */
function mostrar(id){
  ["telaHome","telaCadastrar","telaVisualizar","telaExecucao","telaResumo"]
    .forEach(t=>document.getElementById(t).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  setNav("home");
}

/* =========================
   BACKUP (EXPORT / IMPORT)
========================= */
function exportarBackup(){
  const dados = localStorage.getItem(KEY);
  if(!dados) return alert("Nada para exportar.");
  const blob = new Blob([dados],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "backup_treinos.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importarBackup(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;

    try{
      const text = await file.text();
      const data = JSON.parse(text);

      if(!Array.isArray(data)) {
        return alert("Arquivo inv√°lido: esperado um JSON com lista de treinos.");
      }

      let treinos = normalizarTreinos(data);

      // remove expirados j√° na importa√ß√£o
      const res = removerTreinosExpirados(treinos);
      treinos = res.filtrados;

      localStorage.setItem(KEY, JSON.stringify(treinos));
      alert("Backup importado com sucesso!");
      renderHome();
      mostrar("telaHome");
    } catch(err){
      alert("N√£o consegui importar esse arquivo. Ele parece estar inv√°lido.");
    }
  };

  input.click();
}

function abrirMenuBackup(){
  const acao = prompt("Backup:\n1 = Exportar\n2 = Importar\n\nDigite 1 ou 2:");
  if(acao === "1") return exportarBackup();
  if(acao === "2") return importarBackup();
}

/* =========================
   EVENTOS
========================= */
document.getElementById("btnNovo").onclick = () => mostrar("telaCadastrar");
document.getElementById("btnCancelar").onclick = () => mostrar("telaHome");
document.getElementById("btnVoltarHome").onclick = () => mostrar("telaHome");
document.getElementById("btnIniciar").onclick = iniciarExecucao;
document.getElementById("btnFinalizar").onclick = finalizar;

document.getElementById("btnPularDescanso").onclick = pularDescanso;

document.getElementById("btnVoltarResumo").onclick = () => {
  renderHome();
  mostrar("telaHome");
};

document.getElementById("btnSalvar").onclick = () => {
  const nome = document.getElementById("inputNome").value.trim();
  const descricao = document.getElementById("inputDescricao").value.trim();
  const inicio = document.getElementById("inputInicio").value || null; // ISO
  const fim = document.getElementById("inputFim").value || null;       // ISO
  const raw = document.getElementById("inputRaw").value.trim();

  if(!nome || !raw) return alert("Preencha o nome e os exerc√≠cios.");

  // valida per√≠odo (se ambos existirem)
  if(inicio && fim){
    const iniMs = new Date(inicio + "T00:00:00").getTime();
    const fimMs = fimDoDiaMsFromISO(fim);
    if(iniMs > fimMs){
      return alert("A data de in√≠cio n√£o pode ser depois da data final.");
    }
  }

  const exercicios = parseLinhas(raw);
  const invalidos = exercicios.filter(e => !e.series || !e.reps);
  if(invalidos.length){
    return alert("Tem exerc√≠cio sem s√©ries/reps no formato NxM (ex: 2x10). Corrija antes de salvar.");
  }

  let treinos = normalizarTreinos(getTreinos());
  treinos.push({
    nome,
    descricao,
    periodo: { inicio, fim },
    exercicios,
    stats: { feitos: 0, ultimaVezMs: null }
  });

  // limpa expirados imediatamente (caso algu√©m salve com fim no passado)
  const res = removerTreinosExpirados(treinos);
  treinos = res.filtrados;

  setTreinos(treinos);

  document.getElementById("inputNome").value = "";
  document.getElementById("inputDescricao").value = "";
  document.getElementById("inputInicio").value = "";
  document.getElementById("inputFim").value = "";
  document.getElementById("inputRaw").value = "";

  renderHome();
  mostrar("telaHome");
};

document.getElementById("navHome").onclick = () => {
  setNav("home");
  mostrar("telaHome");
};

document.getElementById("navBackup").onclick = () => {
  setNav("backup");
  abrirMenuBackup();
};

/* =========================
   INIT
========================= */
renderHome();
setNav("home");
atualizarUI_Descanso();
</script>

</body>
</html>
