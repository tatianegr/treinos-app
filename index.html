<!doctype html>
<html lang="pt-BR" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Treinos + Timer</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<link rel="icon" href="icons/icon-192.png">

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      colors: {
        pinkshock: '#ff2d8d'
      }
    }
  }
}
</script>
</head>

<body class="bg-slate-950 text-slate-100 pb-24">

<div class="max-w-xl mx-auto p-4">

<!-- HOME -->
<section id="telaHome">
  <h1 class="text-2xl font-semibold mb-6">Meus treinos</h1>
  <div id="listaTreinos"></div>

  <button id="btnNovo"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock">
    + Novo treino
  </button>
</section>

<!-- CADASTRAR -->
<section id="telaCadastrar" class="hidden">
  <h1 class="text-2xl font-semibold mb-6">Novo treino</h1>

  <input id="inputNome"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mb-3"
    placeholder="Nome do treino" />

  <textarea id="inputRaw"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 min-h-[120px]"
    placeholder="Agachamento | 4x10 | descanso 60"></textarea>

  <div class="flex gap-2 mt-3">
    <button id="btnSalvar"
      class="flex-1 rounded-xl px-4 py-2 bg-pinkshock">
      Salvar
    </button>
    <button id="btnCancelar"
      class="rounded-xl px-4 py-2 bg-slate-800">
      Cancelar
    </button>
  </div>

  <p class="text-xs text-slate-400 mt-3 leading-relaxed">
    Dica de formato por linha: <span class="text-slate-200">Exerc√≠cio | 4x10 | descanso 60</span><br>
    Se n√£o informar descanso, ele assume 60s. Se n√£o informar s√©ries, assume 3.
  </p>
</section>

<!-- VISUALIZA√á√ÉO -->
<section id="telaVisualizar" class="hidden">
  <button id="btnVoltarHome" class="text-sm text-pinkshock mb-4">‚Üê Voltar</button>
  <h1 id="tituloTreino" class="text-2xl font-semibold mb-4"></h1>

  <div id="listaExerciciosVisual"></div>

  <button id="btnIniciar"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-green-600">
    INICIAR
  </button>
</section>

<!-- EXECU√á√ÉO -->
<section id="telaExecucao" class="hidden">

  <!-- TOPO FIXO COM TEMPO TOTAL + DESCANSO INTEGRADO -->
  <div class="sticky top-0 bg-slate-950 pt-4 pb-3 mb-4 border-b border-slate-800 z-10">
    <div class="flex items-end justify-between gap-4">
      <div>
        <span class="text-sm text-slate-400">Tempo de treino</span>
        <div id="timerTotal" class="text-3xl font-bold text-pinkshock">00:00</div>
      </div>

      <div class="text-right">
        <span class="text-sm text-slate-400">Descanso</span>
        <div id="timerDescansoMini" class="text-xl font-semibold text-slate-200">--:--</div>
      </div>
    </div>

    <!-- Banner do descanso (aparece s√≥ quando est√° rolando) -->
    <div id="boxDescanso" class="hidden mt-3 rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-400">em descanso</div>
          <div class="flex items-baseline gap-2">
            <div id="timerDescanso" class="text-2xl font-bold text-slate-100">00:00</div>
            <div id="descansoMeta" class="text-sm text-slate-400">de 00:00</div>
          </div>
        </div>

        <button id="btnPularDescanso"
          class="shrink-0 rounded-xl px-3 py-2 bg-pinkshock text-sm font-semibold">
          Pular
        </button>
      </div>

      <div class="mt-3">
        <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
          <div id="barraDescanso" class="h-full bg-pinkshock w-0"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="listaExerciciosExec"></div>

  <button id="btnFinalizar"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock">
    Finalizar treino
  </button>

</section>

</div>

<nav class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800">
  <div class="max-w-xl mx-auto flex">
    <button id="navHome"
      class="flex-1 py-3 text-sm font-medium text-pinkshock">
      üè† Home
    </button>
    <button id="navBackup"
      class="flex-1 py-3 text-sm font-medium text-slate-400">
      üíæ Backup
    </button>
  </div>
</nav>

<script>
/* =========================
   CONFIG / ESTADO
========================= */
const KEY = "treinos_app_final_v2";
let treinoAtual = null;

let totalInterval = null;
let descansoInterval = null;

let totalSegundos = 0;
let descansoSegundos = 0;
let descansoTotal = 0;

/* =========================
   HELPERS
========================= */
function formatar(seg){
  const m = String(Math.floor(seg/60)).padStart(2,"0");
  const s = String(seg%60).padStart(2,"0");
  return `${m}:${s}`;
}

function setNav(ativo){
  const home = document.getElementById("navHome");
  const backup = document.getElementById("navBackup");

  if(ativo === "home"){
    home.classList.remove("text-slate-400");
    home.classList.add("text-pinkshock");
    backup.classList.remove("text-pinkshock");
    backup.classList.add("text-slate-400");
  } else {
    backup.classList.remove("text-slate-400");
    backup.classList.add("text-pinkshock");
    home.classList.remove("text-pinkshock");
    home.classList.add("text-slate-400");
  }
}

/* =========================
   TIMERS
========================= */
function iniciarTempoTotal(){
  clearInterval(totalInterval);
  totalSegundos = 0;
  document.getElementById("timerTotal").textContent = "00:00";

  totalInterval = setInterval(()=>{
    totalSegundos++;
    document.getElementById("timerTotal").textContent = formatar(totalSegundos);
  },1000);
}

function atualizarUI_Descanso(){
  const box = document.getElementById("boxDescanso");
  const mini = document.getElementById("timerDescansoMini");
  const timer = document.getElementById("timerDescanso");
  const meta = document.getElementById("descansoMeta");
  const barra = document.getElementById("barraDescanso");

  if(descansoSegundos > 0){
    box.classList.remove("hidden");
    mini.textContent = formatar(descansoSegundos);
    timer.textContent = formatar(descansoSegundos);
    meta.textContent = `de ${formatar(descansoTotal)}`;

    const pct = Math.max(0, Math.min(100, Math.round(((descansoTotal - descansoSegundos) / descansoTotal) * 100)));
    barra.style.width = pct + "%";
  } else {
    box.classList.add("hidden");
    mini.textContent = "--:--";
    timer.textContent = "00:00";
    meta.textContent = "de 00:00";
    barra.style.width = "0%";
  }
}

function iniciarDescanso(seg){
  clearInterval(descansoInterval);

  descansoTotal = Math.max(1, Number(seg) || 60);
  descansoSegundos = descansoTotal;

  atualizarUI_Descanso();

  descansoInterval = setInterval(()=>{
    descansoSegundos--;
    atualizarUI_Descanso();

    if(descansoSegundos <= 0){
      clearInterval(descansoInterval);
      descansoSegundos = 0;
      atualizarUI_Descanso();
      navigator.vibrate?.(200);
    }
  },1000);
}

function pularDescanso(){
  clearInterval(descansoInterval);
  descansoSegundos = 0;
  atualizarUI_Descanso();
}

/* =========================
   STORAGE
========================= */
function getTreinos(){
  return JSON.parse(localStorage.getItem(KEY) || "[]");
}
function setTreinos(data){
  localStorage.setItem(KEY, JSON.stringify(data));
}

/* =========================
   PARSER
========================= */
function parseLinhas(raw){
  return raw
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean)
    .map(l=>{
      const partes = l.split("|").map(p=>p.trim());

      // partes[1] -> "4x10" (ou "4x")
      const match = (partes[1] || "").match(/(\d+)\s*x\s*(\d+)?/i);

      // descanso -> pega primeiro n√∫mero
      const descansoMatch = (partes[2] || "").match(/(\d+)/);

      return {
        nome: partes[0] || "Exerc√≠cio",
        series: match ? Number(match[1]) : 3,
        descanso: descansoMatch ? Number(descansoMatch[1]) : 60,
        feitas: 0
      };
    });
}

/* =========================
   RENDER
========================= */
function renderHome(){
  const treinos = getTreinos();
  const host = document.getElementById("listaTreinos");
  host.innerHTML="";

  if(!treinos.length){
    host.innerHTML="<p class='text-slate-400'>Nenhum treino criado.</p>";
    return;
  }

  treinos.forEach((t,i)=>{
    host.innerHTML+=`
      <div class="bg-slate-900 p-3 rounded-xl mb-3 border border-slate-800">
        <div class="flex justify-between items-center">
          <div>
            <div class="font-medium">${t.nome}</div>
            <div class="text-xs text-slate-400">${(t.exercicios||[]).length} exerc√≠cios</div>
          </div>
          <button onclick="abrirTreino(${i})" class="text-pinkshock text-sm font-semibold">Ver</button>
        </div>
      </div>
    `;
  });
}

function abrirTreino(i){
  treinoAtual = getTreinos()[i];
  document.getElementById("tituloTreino").textContent = treinoAtual.nome;
  mostrar("telaVisualizar");
  renderVisual();
}

function renderVisual(){
  const host = document.getElementById("listaExerciciosVisual");
  host.innerHTML="";

  (treinoAtual.exercicios || []).forEach(e=>{
    host.innerHTML+=`
      <div class="bg-slate-900 p-3 rounded-xl mb-3 border border-slate-800">
        <div class="font-medium">${e.nome}</div>
        <div class="text-sm text-slate-400">${e.series} s√©ries ‚Ä¢ descanso ${e.descanso}s</div>
      </div>
    `;
  });
}

function iniciarExecucao(){
  iniciarTempoTotal();

  // garante descanso "limpo" ao iniciar
  clearInterval(descansoInterval);
  descansoSegundos = 0;
  descansoTotal = 0;
  atualizarUI_Descanso();

  mostrar("telaExecucao");
  renderExecucao();
}

function renderExecucao(){
  const host = document.getElementById("listaExerciciosExec");
  host.innerHTML="";

  (treinoAtual.exercicios || []).forEach((e,i)=>{
    const concluido = e.feitas >= e.series;
    host.innerHTML+=`
      <div class="bg-slate-900 p-3 rounded-xl mb-3 border border-slate-800">
        <div class="flex justify-between items-center gap-3">
          <div>
            <div class="font-medium">${e.nome}</div>
            <span class="text-sm ${concluido ? "text-green-400" : "text-slate-400"}">${e.feitas}/${e.series}</span>
            <span class="text-xs text-slate-500"> ‚Ä¢ descanso ${e.descanso}s</span>
          </div>
          <button onclick="marcarSerie(${i})"
            class="text-sm px-3 py-1 rounded-lg font-semibold ${concluido ? "bg-slate-800 text-slate-400 cursor-not-allowed" : "bg-pinkshock text-white"}"
            ${concluido ? "disabled" : ""}>
            S√©rie feita
          </button>
        </div>
      </div>
    `;
  });
}

/* =========================
   A√á√ïES
========================= */
function marcarSerie(i){
  const e = treinoAtual.exercicios[i];
  if(e.feitas < e.series){
    e.feitas++;
    iniciarDescanso(e.descanso);
    renderExecucao();
  }
}

function finalizar(){
  clearInterval(totalInterval);
  clearInterval(descansoInterval);

  descansoSegundos = 0;
  descansoTotal = 0;
  atualizarUI_Descanso();

  // reseta contagem de s√©ries para a pr√≥xima execu√ß√£o
  (treinoAtual.exercicios || []).forEach(e=>e.feitas=0);

  mostrar("telaHome");
  renderHome();
}

/* =========================
   SPA
========================= */
function mostrar(id){
  ["telaHome","telaCadastrar","telaVisualizar","telaExecucao"]
    .forEach(t=>document.getElementById(t).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");

  // destaque do menu
  if(id === "telaHome" || id === "telaCadastrar" || id === "telaVisualizar" || id === "telaExecucao"){
    setNav("home");
  }
}

/* =========================
   BACKUP (EXPORT / IMPORT)
========================= */
function exportarBackup(){
  const dados = localStorage.getItem(KEY);
  if(!dados) return alert("Nada para exportar.");
  const blob = new Blob([dados],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "backup_treinos.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importarBackup(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;

    try{
      const text = await file.text();
      const data = JSON.parse(text);

      if(!Array.isArray(data)) {
        return alert("Arquivo inv√°lido: esperado um JSON com lista de treinos.");
      }

      // valida√ß√£o m√≠nima (sem ser chata)
      for(const t of data){
        if(typeof t?.nome !== "string" || !Array.isArray(t?.exercicios)){
          return alert("Arquivo inv√°lido: estrutura inesperada.");
        }
      }

      localStorage.setItem(KEY, JSON.stringify(data));
      alert("Backup importado com sucesso!");
      renderHome();
      mostrar("telaHome");
    } catch(err){
      alert("N√£o consegui importar esse arquivo. Ele parece estar inv√°lido.");
    }
  };

  input.click();
}

function abrirMenuBackup(){
  const acao = prompt("Backup:\n1 = Exportar\n2 = Importar\n\nDigite 1 ou 2:");
  if(acao === "1") return exportarBackup();
  if(acao === "2") return importarBackup();
}

/* =========================
   EVENTOS
========================= */
document.getElementById("btnNovo").onclick = () => mostrar("telaCadastrar");
document.getElementById("btnCancelar").onclick = () => mostrar("telaHome");
document.getElementById("btnVoltarHome").onclick = () => mostrar("telaHome");
document.getElementById("btnIniciar").onclick = iniciarExecucao;
document.getElementById("btnFinalizar").onclick = finalizar;

document.getElementById("btnPularDescanso").onclick = pularDescanso;

document.getElementById("btnSalvar").onclick = () => {
  const nome = document.getElementById("inputNome").value.trim();
  const raw = document.getElementById("inputRaw").value.trim();
  if(!nome || !raw) return alert("Preencha os campos");

  const treinos = getTreinos();
  treinos.push({nome, exercicios: parseLinhas(raw)});
  setTreinos(treinos);

  // limpa form
  document.getElementById("inputNome").value = "";
  document.getElementById("inputRaw").value = "";

  renderHome();
  mostrar("telaHome");
};

document.getElementById("navHome").onclick = () => {
  setNav("home");
  mostrar("telaHome");
};

document.getElementById("navBackup").onclick = () => {
  setNav("backup");
  abrirMenuBackup();
};

/* =========================
   INIT
========================= */
renderHome();
setNav("home");
atualizarUI_Descanso();
</script>

</body>
</html>
