<!doctype html>
<html lang="pt-BR" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Treinos + Timer</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<link rel="icon" href="icons/icon-192.png">

<script src="https://cdn.tailwindcss.com"></script>

<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: { colors: { pinkshock: '#ff2d8d' } }
  }
}
</script>
</head>

<body class="bg-slate-950 text-slate-100 pb-24">

<div class="max-w-xl mx-auto p-4">

<!-- HOME -->
<section id="telaHome">
  <h1 class="text-3xl font-extrabold mb-4 text-center text-pinkshock">Ol√°, Tati!</h1>

  <!-- semana -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 mb-4">
    <div class="text-sm font-semibold">Sua semana</div>
    <div id="semanaResumo" class="text-sm text-slate-300 mt-1">Voc√™ treinou 0 dia(s) esta semana.</div>

    <div id="semanaBolinhas" class="mt-3 flex items-center justify-between gap-2"></div>

    <div class="text-[11px] text-slate-400 mt-3 leading-relaxed">
      Regra: o dia de hoje fica <span class="text-sky-300">azul</span> at√© voc√™ concluir um treino. Se passar o dia sem treinar, vira <span class="text-red-300">vermelho</span>. Se treinar, vira <span class="text-green-300">verde</span>.
    </div>
  </div>

  <!-- progresso do per√≠odo -->
  <div id="boxProgressoPeriodo" class="hidden rounded-2xl border border-slate-800 bg-slate-900/40 p-4 mb-4">
    <div class="text-sm font-semibold">Barra do treino atual</div>
    <div id="progressoPeriodoNome" class="text-sm text-slate-300 mt-1">‚Äî</div>

    <div class="mt-3">
      <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
        <div id="progressoPeriodoBarra" class="h-full bg-pinkshock w-0"></div>
      </div>
      <div id="progressoPeriodoTexto" class="text-xs text-slate-400 mt-2">‚Äî</div>
    </div>
  </div>

  <!-- treinos -->
  <h2 class="text-lg font-semibold mb-3">Meus treinos</h2>
  <div id="listaTreinos"></div>

  <button id="btnNovo"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock">
    + Novo treino
  </button>
</section>

<!-- CADASTRAR / EDITAR -->
<section id="telaCadastrar" class="hidden">
  <h1 id="tituloCadastro" class="text-2xl font-semibold mb-6">Novo treino</h1>

  <label class="text-xs text-slate-400">Nome do treino</label>
  <input id="inputNome"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mb-3 mt-1"
    placeholder="Treino 1" />

  <label class="text-xs text-slate-400">Descri√ß√£o (tipo do treino)</label>
  <input id="inputDescricao"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mb-3 mt-1"
    placeholder="Perna, Bra√ßo, Costas + b√≠ceps..." />

  <div class="grid grid-cols-2 gap-3 mb-4">
    <div>
      <label class="text-xs text-slate-400">Data de in√≠cio (opcional)</label>
      <input id="inputInicio" type="date"
        class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mt-1" />
    </div>
    <div>
      <label class="text-xs text-slate-400">Data final (opcional)</label>
      <input id="inputFim" type="date"
        class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 mt-1" />
    </div>
  </div>

  <!-- CARDIO -->
  <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 mb-4">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold">Cardio</div>
        <div class="text-xs text-slate-400 mt-1">Ter√° cardio neste treino?</div>
      </div>

      <div class="flex gap-2">
        <button id="btnCardioNao" class="px-3 py-2 rounded-xl bg-slate-800 text-sm font-semibold text-slate-200">N√£o</button>
        <button id="btnCardioSim" class="px-3 py-2 rounded-xl bg-pinkshock text-sm font-semibold text-white">Sim</button>
      </div>
    </div>

    <div id="boxCardioConfig" class="hidden mt-4">
      <div class="text-xs text-slate-400 mb-2">
        Adicione 1 ou mais op√ß√µes de cardio e o tempo de cada uma (em minutos).
      </div>

      <div id="listaCardioConfig" class="space-y-2"></div>

      <button id="btnAddCardio"
        class="mt-3 w-full rounded-xl px-4 py-2 bg-slate-800 text-sm font-semibold">
        + Adicionar cardio
      </button>
    </div>
  </div>

  <!-- EXERC√çCIOS -->
  <label class="text-xs text-slate-400">Exerc√≠cios</label>
  <textarea id="inputRaw"
    class="w-full rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 min-h-[160px] mt-1"
    placeholder="Cadeira extensora | 3x12 | descanso 60"></textarea>

  <div class="mt-3 flex gap-2">
    <button id="btnConfigAlternativas"
      class="flex-1 rounded-xl px-4 py-2 bg-slate-800 text-sm font-semibold">
      Configurar alternativas (plano b)
    </button>

    <button id="btnLimparAlternativas"
      class="rounded-xl px-4 py-2 bg-slate-900 border border-slate-800 text-sm font-semibold text-slate-200">
      Limpar
    </button>
  </div>

  <!-- CONFIG ALTERNATIVAS (CADASTRO) -->
  <div id="boxAlternativasCadastro" class="hidden mt-4 rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-sm font-semibold">Alternativas do treino</div>
        <div class="text-xs text-slate-400 mt-1">
          Marque ‚ÄúPlano B obrigat√≥rio‚Äù e cole as alternativas em um √∫nico campo (1 por linha).
        </div>
      </div>
      <button id="btnFecharAlternativas" class="text-slate-300 hover:text-white text-sm font-semibold">Fechar</button>
    </div>

    <div id="listaAlternativasCadastro" class="mt-4 space-y-3"></div>

    <div class="text-[11px] text-slate-400 mt-4 leading-relaxed">
      Dica: formato por linha igual ao plano A:
      <div class="mt-2 text-slate-200">Leg press | 3x12 | descanso 60</div>
      <div class="mt-2 text-slate-400">Sem descanso: voc√™ pode omitir ‚Äúdescanso‚Äù.</div>
    </div>
  </div>

  <div class="flex gap-2 mt-4">
    <button id="btnSalvar"
      class="flex-1 rounded-xl px-4 py-2 bg-pinkshock">
      Salvar
    </button>
    <button id="btnCancelar"
      class="rounded-xl px-4 py-2 bg-slate-800">
      Cancelar
    </button>
  </div>

  <div class="mt-4 p-3 rounded-xl border border-slate-800 bg-slate-900/40">
    <div class="text-xs text-slate-400 leading-relaxed">
      Formato por linha (sem adivinha√ß√£o):
      <div class="mt-2 text-slate-200">Exerc√≠cio | 2x10 | descanso 60</div>
      <div class="mt-2">
        ‚Ä¢ S√©ries e reps precisam estar em NxM (ex: 2x10)<br>
        ‚Ä¢ Se n√£o informar descanso, fica ‚Äúsem descanso definido‚Äù<br>
        ‚Ä¢ Se definir data final, o treino ser√° apagado automaticamente ap√≥s essa data
      </div>
    </div>
  </div>
</section>

<!-- VISUALIZA√á√ÉO -->
<section id="telaVisualizar" class="hidden">
  <button id="btnVoltarHome" class="text-sm text-pinkshock mb-4">‚Üê Voltar</button>

  <h1 id="tituloTreino" class="text-2xl font-semibold"></h1>
  <div id="subtituloTreino" class="text-sm text-slate-400 mt-1 mb-3"></div>

  <div id="boxCardioResumo" class="hidden mb-3 rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
    <div class="text-xs text-slate-400">Cardio</div>
    <div id="cardioResumoTexto" class="text-sm text-slate-200 mt-1"></div>
  </div>

  <div class="text-xs text-slate-400 mb-2 flex justify-between">
    <span>exerc√≠cio</span>
    <span>s√©ries ‚Ä¢ reps ‚Ä¢ descanso</span>
  </div>

  <div id="listaExerciciosVisual" class="border border-slate-800 rounded-xl overflow-hidden"></div>

  <button id="btnIniciar"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-green-600 font-semibold">
    INICIAR
  </button>
</section>

<!-- EXECU√á√ÉO -->
<section id="telaExecucao" class="hidden">

  <div class="sticky top-0 bg-slate-950 pt-4 pb-3 mb-4 border-b border-slate-800 z-10">
    <div class="text-center">
      <div class="text-sm text-slate-400">Cron√¥metro do treino</div>
      <div id="timerTotal" class="text-5xl font-extrabold text-pinkshock tracking-tight">00:00</div>
    </div>

    <!-- DESCANSO -->
    <div id="boxDescanso" class="hidden mt-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-400">descanso</div>
          <div class="flex items-baseline gap-2">
            <div id="timerDescanso" class="text-2xl font-bold text-slate-100">00:00</div>
            <div id="descansoMeta" class="text-sm text-slate-400">de 00:00</div>
          </div>
        </div>

        <button id="btnPularDescanso"
          class="shrink-0 rounded-xl px-3 py-2 bg-pinkshock text-sm font-semibold">
          Pular
        </button>
      </div>

      <div class="mt-3">
        <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
          <div id="barraDescanso" class="h-full bg-pinkshock w-0"></div>
        </div>
      </div>
    </div>

    <!-- CARDIO TIMER -->
    <div id="boxCardioTimer" class="hidden mt-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-3">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-xs uppercase tracking-wide text-slate-400">cardio</div>
          <div id="cardioAtualNome" class="text-sm font-semibold text-slate-200 truncate mt-1">‚Äî</div>
          <div class="flex items-baseline gap-2 mt-1">
            <div id="timerCardio" class="text-2xl font-bold text-slate-100">00:00</div>
            <div id="cardioMeta" class="text-sm text-slate-400">de 00:00</div>
          </div>
        </div>

        <div class="shrink-0 flex gap-2">
          <button id="btnCardioPlayPause" class="rounded-xl px-3 py-2 bg-pinkshock text-sm font-semibold">Iniciar</button>
          <button id="btnPularCardio" class="rounded-xl px-3 py-2 bg-slate-800 text-sm font-semibold">Pular</button>
        </div>
      </div>

      <div class="mt-3">
        <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden">
          <div id="barraCardio" class="h-full bg-pinkshock w-0"></div>
        </div>
      </div>

      <div id="cardioFila" class="mt-3 text-xs text-slate-400"></div>
    </div>
  </div>

  <!-- EXERC√çCIOS -->
  <div class="text-xs text-slate-400 mb-2 flex justify-between">
    <span>exerc√≠cio</span>
    <span>s√©ries</span>
  </div>
  <div id="listaExerciciosExec" class="border border-slate-800 rounded-xl overflow-hidden"></div>

  <!-- CARDIO LISTA (EXEC) -->
  <div id="boxCardioExec" class="hidden mt-4 rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm font-semibold">Cardio do treino</div>
        <div class="text-xs text-slate-400 mt-1">Voc√™ pode fazer o cardio quando quiser durante o treino.</div>
      </div>
      <button id="btnAbrirCardioTimer" class="rounded-xl px-3 py-2 bg-pinkshock text-sm font-semibold">
        Abrir cardio
      </button>
    </div>

    <div id="listaCardioExec" class="mt-3 space-y-2"></div>
  </div>

  <button id="btnFinalizar"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock font-semibold">
    Finalizar treino
  </button>

</section>

<!-- RESUMO FINAL -->
<section id="telaResumo" class="hidden">
  <h1 class="text-2xl font-semibold mb-4">Resumo do treino</h1>

  <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
    <div class="text-sm text-slate-400">Dura√ß√£o</div>
    <div id="resumoDuracao" class="text-4xl font-extrabold text-pinkshock mt-1">00:00</div>

    <div class="mt-4 grid grid-cols-2 gap-3">
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
        <div class="text-xs text-slate-400">In√≠cio</div>
        <div id="resumoInicio" class="text-sm font-semibold text-slate-200 mt-1">‚Äî</div>
      </div>
      <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-3">
        <div class="text-xs text-slate-400">Fim</div>
        <div id="resumoFim" class="text-sm font-semibold text-slate-200 mt-1">‚Äî</div>
      </div>
    </div>

    <div class="mt-3 text-xs text-slate-400">
      <span id="resumoData">‚Äî</span>
    </div>
  </div>

  <div id="boxResumoTrocas" class="hidden mt-4 rounded-2xl border border-slate-800 bg-slate-900/60 p-4">
    <div class="text-sm font-semibold">Trocas do treino</div>
    <div id="resumoTrocasLista" class="mt-2 space-y-2"></div>
  </div>

  <button id="btnVoltarResumo"
    class="mt-4 w-full rounded-xl px-4 py-2 bg-pinkshock font-semibold">
    Voltar para Home
  </button>
</section>

</div>

<nav class="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800">
  <div class="max-w-xl mx-auto flex">
    <button id="navHome"
      class="flex-1 py-3 text-sm font-medium text-pinkshock">
      üè† Home
    </button>
    <button id="navBackup"
      class="flex-1 py-3 text-sm font-medium text-slate-400">
      üíæ Backup
    </button>
  </div>
</nav>

<!-- MODAL TROCAR EXERC√çCIO -->
<div id="modalTroca" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/60"></div>

  <div class="relative max-w-xl mx-auto h-full flex items-end p-4">
    <div class="w-full rounded-2xl border border-slate-800 bg-slate-950 p-4">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="text-sm text-slate-400">trocar exerc√≠cio</div>
          <div id="modalTrocaTitulo" class="text-lg font-semibold text-slate-100 truncate mt-1">‚Äî</div>
          <div id="modalTrocaSub" class="text-xs text-slate-400 mt-1">s√≥ √© poss√≠vel trocar antes de iniciar (0 s√©ries feitas).</div>
        </div>
        <button id="btnFecharModalTroca" class="text-slate-300 hover:text-white text-sm font-semibold">Fechar</button>
      </div>

      <div id="modalTrocaOpcoes" class="mt-4 space-y-2"></div>

      <div class="mt-4 text-xs text-slate-400">
        Motivo (opcional): ao escolher uma alternativa, voc√™ pode registrar ‚Äúm√°quina ocupada‚Äù, etc. (aparece no resumo).
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG / ESTADO
========================= */
const KEY = "treinos_app_final_v2";
const KEY_SESSIONS = "treinos_app_sessions_v1";

let treinoAtual = null;
let treinoAtualIndex = null;

let totalInterval = null;
let descansoInterval = null;
let cardioInterval = null;

let totalSegundos = 0;
let treinoInicioMs = null;

let descansoSegundos = 0;
let descansoTotal = 0;

// cardio timer state
let cardioAtivo = false;
let cardioPausado = true;
let cardioIndex = 0;
let cardioRestante = 0;
let cardioTotalAtual = 0;

// sess√£o (resumo)
let sessionSwaps = []; // [{exKey, planejado, executado, motivo}]
let sessionStartMs = null;
let sessionEndMs = null;

// cadastro/edi√ß√£o
let editIndex = null; // null = novo, number = editando
function setModoCadastro(isEdit){
  const h = document.getElementById("tituloCadastro");
  h.textContent = isEdit ? "Editar treino" : "Novo treino";
  editIndex = isEdit ? editIndex : null;
}

// alternativas (cadastro)
let altDraft = []; // [{...ex, altObrigatorio, altRaw}]
let altDraftDirty = false;

const CARDIO_OPCOES = ["Esteira","Bike","Escada"];

const MOTIVOS_TROCA = [
  "m√°quina ocupada",
  "equipamento indispon√≠vel",
  "lotado / sem espa√ßo",
  "outro"
];

/* =========================
   HELPERS
========================= */
function esc(s=""){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function formatar(seg){
  const m = String(Math.floor(seg/60)).padStart(2,"0");
  const s = String(seg%60).padStart(2,"0");
  return `${m}:${s}`;
}
function pad2(n){ return String(n).padStart(2,"0"); }
function formatarDataHora(ms){
  const d = new Date(ms);
  const dia = pad2(d.getDate());
  const mes = pad2(d.getMonth()+1);
  const ano = d.getFullYear();
  const hh = pad2(d.getHours());
  const mm = pad2(d.getMinutes());
  return { data: `${dia}/${mes}/${ano}`, hora: `${hh}:${mm}` };
}
function formatarDataISOparaBR(iso){
  if(!iso) return null;
  const [y,m,d] = iso.split("-");
  if(!y || !m || !d) return null;
  return `${d}/${m}/${y}`;
}
function agoraMs(){ return Date.now(); }
function inicioDoDiaMs(dt = new Date()){
  const d = new Date(dt);
  d.setHours(0,0,0,0);
  return d.getTime();
}
function fimDoDiaMsFromISO(iso){
  const d = new Date(iso + "T23:59:59.999");
  return d.getTime();
}
function setNav(ativo){
  const home = document.getElementById("navHome");
  const backup = document.getElementById("navBackup");

  if(ativo === "home"){
    home.classList.remove("text-slate-400");
    home.classList.add("text-pinkshock");
    backup.classList.remove("text-pinkshock");
    backup.classList.add("text-slate-400");
  } else {
    backup.classList.remove("text-slate-400");
    backup.classList.add("text-pinkshock");
    home.classList.remove("text-pinkshock");
    home.classList.add("text-slate-400");
  }
}

/* semana (segunda->domingo) */
function getSemanaAtualDatas(){
  const now = new Date();
  const today0 = inicioDoDiaMs(now);
  const d = new Date(today0);
  const jsDay = d.getDay(); // 0 dom, 1 seg...
  const diffToMon = (jsDay === 0) ? -6 : (1 - jsDay);
  const mon = new Date(d);
  mon.setDate(mon.getDate() + diffToMon);
  mon.setHours(0,0,0,0);

  const days = [];
  for(let i=0;i<7;i++){
    const x = new Date(mon);
    x.setDate(mon.getDate() + i);
    x.setHours(0,0,0,0);
    days.push(x.getTime());
  }
  return { startMs: days[0], daysMs: days, today0 };
}

function dayKey(ms){
  const d = new Date(ms);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

/* =========================
   TIMERS
========================= */
function iniciarCronometroTreino(){
  clearInterval(totalInterval);
  totalSegundos = 0;
  document.getElementById("timerTotal").textContent = "00:00";

  totalInterval = setInterval(()=>{
    totalSegundos++;
    document.getElementById("timerTotal").textContent = formatar(totalSegundos);
  },1000);
}

/* descanso */
function atualizarUI_Descanso(){
  const box = document.getElementById("boxDescanso");
  const timer = document.getElementById("timerDescanso");
  const meta = document.getElementById("descansoMeta");
  const barra = document.getElementById("barraDescanso");

  if(descansoSegundos > 0){
    box.classList.remove("hidden");
    timer.textContent = formatar(descansoSegundos);
    meta.textContent = `de ${formatar(descansoTotal)}`;

    const pct = Math.max(0, Math.min(100, Math.round(((descansoTotal - descansoSegundos) / descansoTotal) * 100)));
    barra.style.width = pct + "%";
  } else {
    box.classList.add("hidden");
    timer.textContent = "00:00";
    meta.textContent = "de 00:00";
    barra.style.width = "0%";
  }
}
function iniciarDescanso(seg){
  const s = Number(seg);
  if(!Number.isFinite(s) || s <= 0) return;

  clearInterval(descansoInterval);
  descansoTotal = Math.floor(s);
  descansoSegundos = descansoTotal;
  atualizarUI_Descanso();

  descansoInterval = setInterval(()=>{
    descansoSegundos--;
    atualizarUI_Descanso();

    if(descansoSegundos <= 0){
      clearInterval(descansoInterval);
      descansoSegundos = 0;
      atualizarUI_Descanso();
      navigator.vibrate?.(200);
    }
  },1000);
}
function pularDescanso(){
  clearInterval(descansoInterval);
  descansoSegundos = 0;
  descansoTotal = 0;
  atualizarUI_Descanso();
}

/* cardio */
function resetCardioState(){
  clearInterval(cardioInterval);
  cardioAtivo = false;
  cardioPausado = true;
  cardioIndex = 0;
  cardioRestante = 0;
  cardioTotalAtual = 0;

  const box = document.getElementById("boxCardioTimer");
  box.classList.add("hidden");
  document.getElementById("timerCardio").textContent = "00:00";
  document.getElementById("cardioMeta").textContent = "de 00:00";
  document.getElementById("barraCardio").style.width = "0%";
  document.getElementById("cardioAtualNome").textContent = "‚Äî";
  document.getElementById("cardioFila").textContent = "";

  const btn = document.getElementById("btnCardioPlayPause");
  btn.textContent = "Iniciar";
}
function temCardioValido(treino){
  const items = treino?.cardio?.items || [];
  return treino?.cardio?.enabled && Array.isArray(items) && items.some(i => Number(i?.duracaoSeg) > 0);
}
function montarFilaCardioTexto(treino){
  const items = (treino?.cardio?.items || []).filter(i => Number(i?.duracaoSeg) > 0);
  if(!items.length) return "";
  return items.map((it, idx) => {
    const nome = it.tipo || "Cardio";
    const t = formatar(it.duracaoSeg);
    return `${idx+1}. ${nome} (${t})`;
  }).join(" ‚Ä¢ ");
}
function abrirCardioTimer(){
  if(!temCardioValido(treinoAtual)){
    alert("Esse treino n√£o tem cardio configurado (ou est√° sem tempo).");
    return;
  }

  document.getElementById("boxCardioTimer").classList.remove("hidden");

  if(!cardioAtivo){
    cardioAtivo = true;
    cardioPausado = true;
    cardioIndex = 0;
    carregarCardioAtual();
    atualizarUI_Cardio();
  }
}
function carregarCardioAtual(){
  const items = (treinoAtual.cardio.items || []).filter(i => Number(i?.duracaoSeg) > 0);
  if(!items.length){
    resetCardioState();
    return;
  }

  if(cardioIndex >= items.length){
    clearInterval(cardioInterval);
    cardioPausado = true;
    cardioRestante = 0;
    cardioTotalAtual = 0;

    document.getElementById("cardioAtualNome").textContent = "Cardio finalizado";
    document.getElementById("timerCardio").textContent = "00:00";
    document.getElementById("cardioMeta").textContent = "de 00:00";
    document.getElementById("barraCardio").style.width = "100%";
    document.getElementById("btnCardioPlayPause").textContent = "Reiniciar";
    document.getElementById("cardioFila").textContent = montarFilaCardioTexto(treinoAtual);
    navigator.vibrate?.(200);
    return;
  }

  const atual = items[cardioIndex];
  cardioTotalAtual = Number(atual.duracaoSeg) || 0;
  cardioRestante = cardioTotalAtual;

  document.getElementById("cardioAtualNome").textContent = atual.tipo || "Cardio";
  document.getElementById("cardioFila").textContent = montarFilaCardioTexto(treinoAtual);
  document.getElementById("btnCardioPlayPause").textContent = "Iniciar";
}
function atualizarUI_Cardio(){
  const t = document.getElementById("timerCardio");
  const meta = document.getElementById("cardioMeta");
  const barra = document.getElementById("barraCardio");

  t.textContent = formatar(Math.max(0, cardioRestante));
  meta.textContent = `de ${formatar(Math.max(0, cardioTotalAtual))}`;

  if(cardioTotalAtual > 0){
    const pct = Math.max(0, Math.min(100, Math.round(((cardioTotalAtual - cardioRestante) / cardioTotalAtual) * 100)));
    barra.style.width = pct + "%";
  } else {
    barra.style.width = "0%";
  }
}
function tickCardio(){
  cardioRestante--;
  atualizarUI_Cardio();

  if(cardioRestante <= 0){
    clearInterval(cardioInterval);
    cardioRestante = 0;
    atualizarUI_Cardio();
    navigator.vibrate?.(200);

    cardioIndex++;
    cardioPausado = true;
    carregarCardioAtual();
  }
}
function toggleCardioPlayPause(){
  if(!temCardioValido(treinoAtual)){
    alert("Esse treino n√£o tem cardio configurado (ou est√° sem tempo).");
    return;
  }

  const items = (treinoAtual.cardio.items || []).filter(i => Number(i?.duracaoSeg) > 0);
  if(cardioIndex >= items.length){
    cardioAtivo = true;
    cardioPausado = true;
    cardioIndex = 0;
    carregarCardioAtual();
    atualizarUI_Cardio();
  }

  if(cardioPausado){
    if(cardioTotalAtual <= 0) carregarCardioAtual();
    if(cardioRestante <= 0) cardioRestante = cardioTotalAtual;

    cardioPausado = false;
    document.getElementById("btnCardioPlayPause").textContent = "Pausar";
    clearInterval(cardioInterval);
    cardioInterval = setInterval(tickCardio, 1000);
    return;
  }

  cardioPausado = true;
  document.getElementById("btnCardioPlayPause").textContent = "Continuar";
  clearInterval(cardioInterval);
}
function pularCardioAtual(){
  if(!cardioAtivo) return;
  clearInterval(cardioInterval);
  cardioPausado = true;

  cardioIndex++;
  carregarCardioAtual();
  atualizarUI_Cardio();
}

/* =========================
   STORAGE
========================= */
function getTreinos(){
  return JSON.parse(localStorage.getItem(KEY) || "[]");
}
function setTreinos(data){
  localStorage.setItem(KEY, JSON.stringify(data));
}

function getSessions(){
  try{
    return JSON.parse(localStorage.getItem(KEY_SESSIONS) || "[]");
  } catch {
    return [];
  }
}
function setSessions(list){
  localStorage.setItem(KEY_SESSIONS, JSON.stringify(list));
}
function registrarSessaoTreino(treinoNome, fimMs){
  const list = getSessions();
  list.push({
    treinoNome: (treinoNome || "").toString(),
    fimMs: Number(fimMs) || agoraMs(),
    dayKey: dayKey(Number(fimMs) || agoraMs())
  });

  // guarda s√≥ as √∫ltimas 180 sess√µes (pra n√£o crescer infinito)
  const trimmed = list.slice(-180);
  setSessions(trimmed);
}

function normalizarTreinos(treinos){
  treinos.forEach(t=>{
    if(!t.stats || typeof t.stats !== "object"){
      t.stats = { feitos: 0, ultimaVezMs: null };
    } else {
      if(typeof t.stats.feitos !== "number") t.stats.feitos = 0;
      if(typeof t.stats.ultimaVezMs === "undefined") t.stats.ultimaVezMs = null;
    }

    if(typeof t.descricao === "undefined") t.descricao = "";

    if(typeof t.periodo !== "object" || t.periodo === null){
      t.periodo = { inicio: null, fim: null };
    } else {
      if(typeof t.periodo.inicio === "undefined") t.periodo.inicio = null;
      if(typeof t.periodo.fim === "undefined") t.periodo.fim = null;
    }

    // cardio
    if(typeof t.cardio !== "object" || t.cardio === null){
      t.cardio = { enabled: false, items: [] };
    } else {
      if(typeof t.cardio.enabled !== "boolean") t.cardio.enabled = false;
      if(!Array.isArray(t.cardio.items)) t.cardio.items = [];
      t.cardio.items = t.cardio.items.map(i => ({
        tipo: (i?.tipo ?? "").toString(),
        duracaoSeg: Number(i?.duracaoSeg) || 0
      }));
    }

    // alternativas
    if(!Array.isArray(t.exercicios)) t.exercicios = [];
    t.exercicios.forEach(e=>{
      if(typeof e.altObrigatorio !== "boolean") e.altObrigatorio = false;
      if(!Array.isArray(e.alternativas)) e.alternativas = [];
      e.alternativas = e.alternativas.map(a => ({
        nome: (a?.nome ?? "").toString(),
        series: Number(a?.series) || null,
        reps: Number(a?.reps) || null,
        descanso: (typeof a?.descanso === "number") ? a.descanso : (Number(a?.descanso) || null)
      }));
      if(typeof e.selectedAlt !== "number") e.selectedAlt = 0; // 0=plano A, 1..=alternativas
    });

    if(t.lastSession && typeof t.lastSession !== "object"){
      t.lastSession = null;
    }
    if(!Array.isArray(t.lastSessionSwaps)) t.lastSessionSwaps = [];
  });

  return treinos;
}

function removerTreinosExpirados(treinos){
  const hoje0 = inicioDoDiaMs();
  const filtrados = treinos.filter(t=>{
    const fim = t?.periodo?.fim;
    if(!fim) return true;
    const fimMs = fimDoDiaMsFromISO(fim);
    return hoje0 <= fimMs;
  });
  return { filtrados };
}

/* =========================
   PARSER EXERC√çCIOS
========================= */
function parseLinhas(raw){
  return raw
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean)
    .map(l=>{
      const partes = l.split("|").map(p=>p.trim());

      const nome = partes[0] || "Exerc√≠cio";
      const sr = (partes[1] || "").match(/^\s*(\d+)\s*x\s*(\d+)\s*$/i);
      const dm = (partes[2] || "").match(/(\d+)/);

      const series = sr ? Number(sr[1]) : null;
      const reps  = sr ? Number(sr[2]) : null;
      const descanso = dm ? Number(dm[1]) : null;

      return {
        nome, series, reps, descanso,
        feitas: 0,
        altObrigatorio: false,
        alternativas: [],
        selectedAlt: 0
      };
    });
}

function exerciciosToRawPlanoA(exercicios){
  return (exercicios || []).map(e=>{
    const s = e.series ?? "";
    const r = e.reps ?? "";
    const d = (typeof e.descanso === "number" || e.descanso === 0) ? ` | descanso ${e.descanso}` : "";
    return `${e.nome} | ${s}x${r}${d}`.trim();
  }).join("\n");
}

/* =========================
   CARDIO (CADASTRO)
========================= */
let cardioCadastroEnabled = false;

function setCardioCadastro(enabled){
  cardioCadastroEnabled = enabled;

  const box = document.getElementById("boxCardioConfig");
  const btnSim = document.getElementById("btnCardioSim");
  const btnNao = document.getElementById("btnCardioNao");

  if(enabled){
    box.classList.remove("hidden");
    btnSim.classList.add("bg-pinkshock","text-white");
    btnSim.classList.remove("bg-slate-800","text-slate-200");
    btnNao.classList.add("bg-slate-800","text-slate-200");
    btnNao.classList.remove("bg-pinkshock","text-white");
  } else {
    box.classList.add("hidden");
    btnNao.classList.add("bg-pinkshock","text-white");
    btnNao.classList.remove("bg-slate-800","text-slate-200");
    btnSim.classList.add("bg-slate-800","text-slate-200");
    btnSim.classList.remove("bg-pinkshock","text-white");
  }
}

function cardioRowTemplate(tipo="", minutos=""){
  const opts = CARDIO_OPCOES.map(o => `<option value="${esc(o)}" ${o===tipo?"selected":""}>${esc(o)}</option>`).join("");

  return `
  <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
    <div class="grid grid-cols-12 gap-2 items-center">
      <div class="col-span-7">
        <label class="text-[11px] text-slate-400">Tipo</label>
        <select class="cardioTipo w-full mt-1 rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm">
          ${opts}
        </select>
      </div>

      <div class="col-span-4">
        <label class="text-[11px] text-slate-400">Tempo (min)</label>
        <input type="number" min="0" step="1"
          class="cardioMin w-full mt-1 rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm"
          placeholder="Ex: 15" value="${esc(minutos)}">
      </div>

      <div class="col-span-1 flex justify-end">
        <button class="btnRemoverCardio text-slate-300 hover:text-white" title="Remover">‚úï</button>
      </div>
    </div>
  </div>`;
}

function addCardioRow(tipo="Esteira", minutos=""){
  const host = document.getElementById("listaCardioConfig");
  const wrapper = document.createElement("div");
  wrapper.innerHTML = cardioRowTemplate(tipo, minutos);
  host.appendChild(wrapper);

  const btnRem = wrapper.querySelector(".btnRemoverCardio");
  btnRem.addEventListener("click", () => wrapper.remove());
}

function coletarCardioDoCadastro(){
  if(!cardioCadastroEnabled) return { enabled:false, items:[] };

  const rows = Array.from(document.querySelectorAll("#listaCardioConfig > div"));
  const items = [];

  rows.forEach(r=>{
    const tipoEl = r.querySelector(".cardioTipo");
    const minEl = r.querySelector(".cardioMin");

    let tipo = (tipoEl?.value || "").trim();
    if(!tipo) tipo = "Esteira";

    const minutos = Number(minEl?.value || 0);
    const duracaoSeg = Math.max(0, Math.floor(minutos * 60));

    if(duracaoSeg > 0){
      items.push({ tipo, duracaoSeg });
    }
  });

  return { enabled: items.length > 0, items };
}

function limparCardioCadastroUI(){
  document.getElementById("listaCardioConfig").innerHTML = "";
  addCardioRow("Esteira", "");
}

/* =========================
   ALTERNATIVAS (CADASTRO) - 1 campo
========================= */
function altsToRaw(ex){
  const alts = Array.isArray(ex?.alternativas) ? ex.alternativas : [];
  if(!alts.length) return "";
  return alts.map(a=>{
    const nm = (a.nome || "").trim() || "Alternativa";
    const s = a.series ?? "";
    const r = a.reps ?? "";
    const d = (typeof a.descanso === "number" || a.descanso === 0) ? ` | descanso ${a.descanso}` : "";
    return `${nm} | ${s}x${r}${d}`.trim();
  }).join("\n");
}

function parseAlternativasRaw(raw){
  const linhas = (raw || "")
    .split("\n")
    .map(x=>x.trim())
    .filter(Boolean);

  const alts = [];
  const invalidas = [];

  linhas.forEach((l)=>{
    const partes = l.split("|").map(p=>p.trim());
    const nome = partes[0] || "Alternativa";
    const sr = (partes[1] || "").match(/^\s*(\d+)\s*x\s*(\d+)\s*$/i);
    const dm = (partes[2] || "").match(/(\d+)/);

    const series = sr ? Number(sr[1]) : null;
    const reps  = sr ? Number(sr[2]) : null;
    const descanso = dm ? Number(dm[1]) : null;

    if(!series || !reps){
      invalidas.push(l);
      return;
    }
    alts.push({ nome, series, reps, descanso });
  });

  return { alts, invalidas };
}

function altCardTemplateV2(ex, idx){
  const badge = ex.altObrigatorio
    ? `<span class="text-[10px] px-2 py-1 rounded-full bg-pinkshock/20 text-pinkshock border border-pinkshock/30">plano b obrigat√≥rio</span>`
    : `<span class="text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-300 border border-slate-700">opcional</span>`;

  return `
  <div class="rounded-2xl border border-slate-800 bg-slate-950/30 p-3">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="font-semibold truncate">${esc(ex.nome)}</div>
        <div class="text-xs text-slate-400 mt-1">
          ${ex.series}x${ex.reps} ‚Ä¢ ${ex.descanso ? `descanso ${ex.descanso}s` : `sem descanso definido`}
        </div>
        <div class="mt-2">${badge}</div>
      </div>
      <label class="inline-flex items-center gap-2 text-xs text-slate-300 select-none shrink-0">
        <input type="checkbox" class="altObrigatorio w-4 h-4 accent-pinkshock" ${ex.altObrigatorio ? "checked" : ""}>
        plano b obrigat√≥rio
      </label>
    </div>

    <div class="mt-3">
      <label class="text-[11px] text-slate-400">Alternativas (1 por linha)</label>
      <textarea class="altRaw w-full mt-1 rounded-xl bg-slate-900 border border-slate-800 px-3 py-2 text-sm min-h-[120px]"
        placeholder="Leg press | 3x12 | descanso 60&#10;Agachamento livre | 3x10 | descanso 90">${esc(ex.altRaw || "")}</textarea>
      <div class="text-[11px] text-slate-500 mt-2">
        Dica: ‚ÄúPrancha | 3x40 | descanso 60‚Äù (interpreta 40 como reps/segundos, do jeitinho que voc√™ j√° est√° usando).
      </div>
    </div>
  </div>`;
}

function abrirConfigAlternativas(){
  const raw = document.getElementById("inputRaw").value.trim();
  if(!raw) return alert("Escreva os exerc√≠cios antes de configurar alternativas.");

  const exercicios = parseLinhas(raw);
  const invalidos = exercicios.filter(e => !e.series || !e.reps);
  if(invalidos.length){
    return alert("Tem exerc√≠cio sem s√©ries/reps no formato NxM (ex: 2x10). Corrija antes de configurar alternativas.");
  }

  // recria draft e tenta reaproveitar configs anteriores por √≠ndice + nome
  const prev = altDraft;
  altDraft = exercicios.map((e, idx)=>{
    const p = prev[idx];
    if(p && p.nome === e.nome){
      e.altObrigatorio = !!p.altObrigatorio;
      e.alternativas = Array.isArray(p.alternativas) ? p.alternativas : [];
      e.altRaw = (typeof p.altRaw === "string") ? p.altRaw : altsToRaw(p);
    } else {
      e.altRaw = "";
    }
    return e;
  });

  altDraftDirty = false;
  renderAltDraft();
  document.getElementById("boxAlternativasCadastro").classList.remove("hidden");
}

function renderAltDraft(){
  const host = document.getElementById("listaAlternativasCadastro");
  host.innerHTML = "";

  altDraft.forEach((ex, idx)=>{
    const wrapper = document.createElement("div");
    wrapper.innerHTML = altCardTemplateV2(ex, idx);
    host.appendChild(wrapper);

    const chk = wrapper.querySelector(".altObrigatorio");
    const tx = wrapper.querySelector(".altRaw");

    chk.addEventListener("change", ()=>{
      altDraft[idx].altObrigatorio = !!chk.checked;
    });

    tx.addEventListener("input", ()=>{
      altDraft[idx].altRaw = tx.value;
    });
  });
}

function limparAlternativasCadastro(){
  altDraft = [];
  altDraftDirty = false;
  document.getElementById("boxAlternativasCadastro").classList.add("hidden");
}

function aplicarAlternativasNoPlanoA(exercicios){
  // aplica altObrigatorio + alternativas parseadas do altDraft
  const out = exercicios.map((e, idx)=>{
    const d = altDraft[idx];
    if(d && d.nome === e.nome){
      e.altObrigatorio = !!d.altObrigatorio;

      const { alts, invalidas } = parseAlternativasRaw(d.altRaw || "");
      if(invalidas.length){
        throw new Error("ALTS_INVALIDAS::" + invalidas.join("\n"));
      }
      e.alternativas = alts;
    }
    return e;
  });
  return out;
}

function validarAltObrigatorias(exercicios){
  const problemas = [];
  exercicios.forEach((e)=>{
    if(e.altObrigatorio){
      const qtd = Array.isArray(e.alternativas) ? e.alternativas.length : 0;
      if(qtd <= 0){
        problemas.push(e.nome);
      }
    }
  });
  return problemas;
}

/* =========================
   ALTERNATIVAS (EXECU√á√ÉO)
========================= */
function getAtivo(ex){
  if(!ex || typeof ex.selectedAlt !== "number" || ex.selectedAlt <= 0) return ex;

  const altIdx = ex.selectedAlt - 1;
  const a = (ex.alternativas || [])[altIdx];
  if(!a) return ex;

  return {
    ...ex,
    nome: a.nome || ex.nome,
    series: a.series || ex.series,
    reps: a.reps || ex.reps,
    descanso: (typeof a.descanso === "number") ? a.descanso : ex.descanso
  };
}

function abrirModalTroca(exIdx){
  const ex = treinoAtual.exercicios[exIdx];
  if(!ex) return;

  if(ex.feitas > 0){
    alert("Pra trocar, esse exerc√≠cio precisa estar com 0 s√©ries feitas (zerado).");
    return;
  }

  const titulo = document.getElementById("modalTrocaTitulo");
  const sub = document.getElementById("modalTrocaSub");
  const opHost = document.getElementById("modalTrocaOpcoes");

  titulo.textContent = ex.nome;
  sub.textContent = ex.altObrigatorio
    ? "este exerc√≠cio tem plano b obrigat√≥rio. se a m√°quina estiver ocupada, escolha uma alternativa."
    : "escolha plano a ou uma alternativa.";

  const opcoes = [];

  opcoes.push({
    label: `Plano A: ${ex.nome}`,
    desc: `${ex.series}x${ex.reps} ‚Ä¢ ${ex.descanso ? `descanso ${ex.descanso}s` : `sem descanso`}`,
    value: 0
  });

  (ex.alternativas || []).forEach((a, idx)=>{
    const nm = a.nome || `Alternativa ${idx+1}`;
    const s = a.series || ex.series;
    const r = a.reps || ex.reps;
    const d = (typeof a.descanso === "number") ? a.descanso : ex.descanso;
    opcoes.push({
      label: `Alternativa: ${nm}`,
      desc: `${s}x${r} ‚Ä¢ ${d ? `descanso ${d}s` : `sem descanso`}`,
      value: idx+1
    });
  });

  opHost.innerHTML = opcoes.map(o=>{
    const selecionado = (ex.selectedAlt === o.value);
    const cls = selecionado ? "border-pinkshock bg-pinkshock/10" : "border-slate-800 bg-slate-900/40";
    return `
      <button class="w-full text-left rounded-2xl border ${cls} p-3 hover:border-slate-600 transition"
        onclick="selecionarOpcaoExercicio(${exIdx}, ${o.value})">
        <div class="text-sm font-semibold text-slate-100">${esc(o.label)}</div>
        <div class="text-xs text-slate-400 mt-1">${esc(o.desc)}</div>
      </button>
    `;
  }).join("");

  document.getElementById("modalTroca").classList.remove("hidden");
}

function fecharModalTroca(){
  document.getElementById("modalTroca").classList.add("hidden");
}

function selecionarOpcaoExercicio(exIdx, selectedAlt){
  const ex = treinoAtual.exercicios[exIdx];
  if(!ex) return;

  if(ex.feitas > 0){
    alert("Pra trocar, esse exerc√≠cio precisa estar com 0 s√©ries feitas (zerado).");
    fecharModalTroca();
    return;
  }

  ex.selectedAlt = selectedAlt;

  const planejado = ex.nome;
  const ativo = getAtivo(ex);
  const executado = ativo.nome;

  const exKey = `${exIdx}__${planejado}`;
  sessionSwaps = sessionSwaps.filter(s => s.exKey !== exKey);

  if(selectedAlt > 0){
    let motivo = "";
    const escolha = prompt(
      `Motivo da troca (opcional):\n` +
      `1 = m√°quina ocupada\n2 = equipamento indispon√≠vel\n3 = lotado / sem espa√ßo\n4 = outro\n\n` +
      `Digite 1-4, ou deixe em branco:`
    );

    if(escolha === "1") motivo = MOTIVOS_TROCA[0];
    else if(escolha === "2") motivo = MOTIVOS_TROCA[1];
    else if(escolha === "3") motivo = MOTIVOS_TROCA[2];
    else if(escolha === "4") motivo = MOTIVOS_TROCA[3];
    else motivo = "";

    sessionSwaps.push({ exKey, planejado, executado, motivo });
  }

  pularDescanso();
  renderExecucao();

  fecharModalTroca();
}

/* =========================
   HOME: semana + progresso per√≠odo
========================= */
function renderSemana(){
  const { daysMs, today0 } = getSemanaAtualDatas();
  const sess = getSessions();

  const trainedSet = new Set();
  sess.forEach(s=>{
    const ms = inicioDoDiaMs(new Date(s.fimMs));
    if(daysMs.includes(ms)){
      trainedSet.add(ms);
    }
  });

  const qtd = trainedSet.size;
  document.getElementById("semanaResumo").textContent = `Voc√™ treinou ${qtd} dia(s) esta semana.`;

  const labels = ["Seg","Ter","Qua","Qui","Sex","S√°b","Dom"];
  const host = document.getElementById("semanaBolinhas");
  host.innerHTML = "";

  daysMs.forEach((ms, idx)=>{
    const treinou = trainedSet.has(ms);

    // cores:
    // hoje: azul se n√£o treinou, verde se treinou
    // passado: verde se treinou, vermelho se n√£o treinou
    // futuro: slate
    let cor = "bg-slate-700 border-slate-600";
    if(ms < today0){
      cor = treinou ? "bg-green-500 border-green-400" : "bg-red-500 border-red-400";
    } else if(ms === today0){
      cor = treinou ? "bg-green-500 border-green-400" : "bg-sky-500 border-sky-400";
    } else {
      cor = "bg-slate-700 border-slate-600";
    }

    const wrap = document.createElement("div");
    wrap.className = "flex flex-col items-center gap-1 flex-1 min-w-0";
    wrap.innerHTML = `
      <div class="w-6 h-6 rounded-full border ${cor}"></div>
      <div class="text-[10px] text-slate-400">${labels[idx]}</div>
    `;
    host.appendChild(wrap);
  });
}

function renderProgressoPeriodo(){
  const treinos = removerTreinosExpirados(normalizarTreinos(getTreinos())).filtrados;
  const box = document.getElementById("boxProgressoPeriodo");
  const nomeEl = document.getElementById("progressoPeriodoNome");
  const barra = document.getElementById("progressoPeriodoBarra");
  const txt = document.getElementById("progressoPeriodoTexto");

  const today0 = inicioDoDiaMs();

  // pega o primeiro treino que tem inicio e fim e cujo per√≠odo inclui hoje
  const atual = treinos.find(t=>{
    const ini = t?.periodo?.inicio;
    const fim = t?.periodo?.fim;
    if(!ini || !fim) return false;
    const iniMs = new Date(ini + "T00:00:00").getTime();
    const fimMs = fimDoDiaMsFromISO(fim);
    return (today0 >= iniMs && today0 <= fimMs);
  });

  if(!atual){
    box.classList.add("hidden");
    return;
  }

  const iniMs = new Date(atual.periodo.inicio + "T00:00:00").getTime();
  const fimMs = fimDoDiaMsFromISO(atual.periodo.fim);

  const totalDias = Math.max(1, Math.round((inicioDoDiaMs(new Date(fimMs)) - inicioDoDiaMs(new Date(iniMs))) / 86400000) + 1);
  const diasPassados = Math.max(1, Math.round((today0 - inicioDoDiaMs(new Date(iniMs))) / 86400000) + 1);

  const pct = Math.max(0, Math.min(100, Math.round((diasPassados / totalDias) * 100)));

  box.classList.remove("hidden");
  nomeEl.textContent = `${atual.nome} ‚Ä¢ ${formatarDataISOparaBR(atual.periodo.inicio)} ‚Üí ${formatarDataISOparaBR(atual.periodo.fim)}`;
  barra.style.width = pct + "%";
  txt.textContent = `${pct}% (${diasPassados}/${totalDias} dia(s))`;
}

/* =========================
   RENDER HOME / VISUAL / EXEC
========================= */
function renderHome(){
  let treinos = normalizarTreinos(getTreinos());
  treinos = removerTreinosExpirados(treinos).filtrados;
  setTreinos(treinos);

  renderSemana();
  renderProgressoPeriodo();

  const host = document.getElementById("listaTreinos");
  host.innerHTML="";

  if(!treinos.length){
    host.innerHTML="<p class='text-slate-400'>Nenhum treino criado.</p>";
    return;
  }

  treinos.forEach((t,i)=>{
    const feitos = t.stats?.feitos ?? 0;
    const ultima = t.stats?.ultimaVezMs ? formatarDataHora(t.stats.ultimaVezMs) : null;

    const desc = (t.descricao || "").trim();
    const periodoIni = t?.periodo?.inicio ? formatarDataISOparaBR(t.periodo.inicio) : null;
    const periodoFim = t?.periodo?.fim ? formatarDataISOparaBR(t.periodo.fim) : null;
    const periodoTxt = (periodoIni || periodoFim) ? `${periodoIni ?? "‚Äî"} ‚Üí ${periodoFim ?? "‚Äî"}` : null;

    const cardioTxt = temCardioValido(t)
      ? `‚Ä¢ cardio: <span class="text-slate-200">${(t.cardio.items || []).filter(x=>x.duracaoSeg>0).length} item(ns)</span>`
      : `‚Ä¢ cardio: ‚Äî`;

    const obrigCount = (t.exercicios || []).filter(e => e.altObrigatorio).length;
    const obrigTxt = obrigCount ? `‚Ä¢ plano b: <span class="text-slate-200">${obrigCount}</span>` : `‚Ä¢ plano b: ‚Äî`;

    host.innerHTML+=`
      <div class="bg-slate-900 p-3 rounded-xl mb-3 border border-slate-800">
        <div class="flex justify-between items-start gap-3">
          <div class="min-w-0">
            <div class="font-medium truncate">${esc(t.nome)}</div>
            ${desc ? `<div class="text-xs text-slate-300 mt-1">${esc(desc)}</div>` : ``}
            <div class="text-xs text-slate-400 mt-1">
              feito <span class="text-slate-200 font-semibold">${feitos}</span> vez(es)
              ${ultima ? `‚Ä¢ √∫ltima: <span class="text-slate-200">${ultima.data}</span>` : `‚Ä¢ √∫ltima: ‚Äî`}
              ${cardioTxt}
              ${obrigTxt}
              ${periodoTxt ? `<br><span class="text-slate-500">per√≠odo:</span> <span class="text-slate-200">${periodoTxt}</span>` : ``}
            </div>
          </div>

          <div class="shrink-0 flex flex-col items-end gap-2">
            <button onclick="abrirTreino(${i})" class="text-pinkshock text-sm font-semibold">Ver</button>
            <button onclick="abrirEdicaoTreino(${i})" class="text-slate-200 text-sm font-semibold">Editar</button>
            <button onclick="apagarTreino(${i})" class="text-red-300 text-sm font-semibold">Apagar</button>
          </div>
        </div>
      </div>
    `;
  });
}

function abrirTreino(i){
  let treinos = normalizarTreinos(getTreinos());
  treinos = removerTreinosExpirados(treinos).filtrados;
  setTreinos(treinos);

  treinoAtualIndex = i;
  treinoAtual = treinos[i];

  if(!treinoAtual){
    renderHome();
    mostrar("telaHome");
    return;
  }

  (treinoAtual.exercicios || []).forEach(e=>{
    if(typeof e.series === "undefined") e.series = null;
    if(typeof e.reps === "undefined") e.reps = null;
    if(typeof e.descanso === "undefined") e.descanso = null;
    if(typeof e.feitas !== "number") e.feitas = 0;

    if(typeof e.altObrigatorio !== "boolean") e.altObrigatorio = false;
    if(!Array.isArray(e.alternativas)) e.alternativas = [];
    if(typeof e.selectedAlt !== "number") e.selectedAlt = 0;
  });

  document.getElementById("tituloTreino").textContent = treinoAtual.nome;

  const desc = (treinoAtual.descricao || "").trim();
  const periodoIni = treinoAtual?.periodo?.inicio ? formatarDataISOparaBR(treinoAtual.periodo.inicio) : null;
  const periodoFim = treinoAtual?.periodo?.fim ? formatarDataISOparaBR(treinoAtual.periodo.fim) : null;
  const periodoTxt = (periodoIni || periodoFim) ? `Per√≠odo: ${periodoIni ?? "‚Äî"} ‚Üí ${periodoFim ?? "‚Äî"}` : "";

  const sub = [ desc ? desc : null, periodoTxt ? periodoTxt : null ].filter(Boolean).join(" ‚Ä¢ ");
  document.getElementById("subtituloTreino").textContent = sub || "";

  const box = document.getElementById("boxCardioResumo");
  const txt = document.getElementById("cardioResumoTexto");
  if(temCardioValido(treinoAtual)){
    box.classList.remove("hidden");
    txt.textContent = (treinoAtual.cardio.items || [])
      .filter(i=>i.duracaoSeg>0)
      .map(i => `${i.tipo} (${formatar(i.duracaoSeg)})`)
      .join(" ‚Ä¢ ");
  } else {
    box.classList.add("hidden");
    txt.textContent = "";
  }

  mostrar("telaVisualizar");
  renderVisual();
}

function renderVisual(){
  const host = document.getElementById("listaExerciciosVisual");
  host.innerHTML="";

  const exs = (treinoAtual.exercicios || []);
  if(!exs.length){
    host.innerHTML = `<div class="p-3 text-slate-400">Sem exerc√≠cios.</div>`;
    return;
  }

  exs.forEach((e, idx)=>{
    const borda = idx === 0 ? "" : " border-t border-slate-800";
    const seriesTxt = (e.series && e.reps) ? `${e.series}` : "‚Äî";
    const repsTxt = (e.series && e.reps) ? `${e.reps}` : "‚Äî";
    const descansoTxt = (e.descanso || e.descanso === 0) ? `${e.descanso ?? "‚Äî"}s` : "‚Äî";

    const invalido = (!e.series || !e.reps);
    const badgeInv = invalido
      ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-red-500/15 text-red-300 border border-red-500/25">corrigir 2x10</span>`
      : ``;

    const badgeB = e.altObrigatorio
      ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-pinkshock/20 text-pinkshock border border-pinkshock/30">plano b obrigat√≥rio</span>`
      : (Array.isArray(e.alternativas) && e.alternativas.length ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-300 border border-slate-700">tem alternativas</span>` : ``);

    host.innerHTML += `
      <div class="flex items-center justify-between gap-3 px-3 py-3 bg-slate-900${borda}">
        <div class="min-w-0">
          <div class="font-medium truncate">${esc(e.nome)}${badgeInv}${badgeB}</div>
          <div class="text-xs text-slate-500">${e.descanso ? `descanso ${e.descanso}s` : `sem descanso definido`}</div>
        </div>
        <div class="text-right text-sm text-slate-200 shrink-0">
          <span class="text-slate-300">${seriesTxt}</span>
          <span class="text-slate-500"> ‚Ä¢ </span>
          <span class="text-slate-300">${repsTxt}</span>
          <span class="text-slate-500"> ‚Ä¢ </span>
          <span class="text-slate-300">${descansoTxt}</span>
        </div>
      </div>
    `;
  });
}

function iniciarExecucao(){
  treinoInicioMs = agoraMs();
  sessionStartMs = treinoInicioMs;
  sessionSwaps = [];

  iniciarCronometroTreino();
  pularDescanso();
  resetCardioState();

  (treinoAtual.exercicios || []).forEach(e=>{
    e.selectedAlt = 0;
  });

  mostrar("telaExecucao");
  renderExecucao();
  renderCardioExec();
}

function renderExecucao(){
  const host = document.getElementById("listaExerciciosExec");
  host.innerHTML="";

  const exs = (treinoAtual.exercicios || []);
  if(!exs.length){
    host.innerHTML = `<div class="p-3 text-slate-400">Sem exerc√≠cios.</div>`;
    return;
  }

  exs.forEach((e, i)=>{
    const ativo = getAtivo(e);

    const invalido = (!ativo.series || !ativo.reps);
    const seriesNum = invalido ? 0 : ativo.series;

    const concluido = (!invalido && e.feitas >= ativo.series);
    const sub = invalido
      ? `defina s√©ries e reps no cadastro (ex: 2x10)`
      : `${ativo.series}x${ativo.reps} ‚Ä¢ ${ativo.descanso ? `descanso ${ativo.descanso}s` : `sem descanso definido`}`;

    const usandoAlt = (e.selectedAlt > 0);
    const badgeAlt = usandoAlt
      ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-pinkshock/20 text-pinkshock border border-pinkshock/30">alternativa</span>`
      : ``;

    const badgeB = e.altObrigatorio
      ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-slate-800 text-slate-200 border border-slate-700">plano b obrigat√≥rio</span>`
      : ``;

    const bolinhas = seriesNum > 0
      ? Array.from({length: seriesNum}).map((_, idx)=>{
          const n = idx + 1;
          const feita = n <= e.feitas;
          const base = "w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold border";
          const cls = feita
            ? "bg-pinkshock border-pinkshock text-white"
            : "bg-slate-950 border-slate-700 text-slate-300";
          return `
            <button
              class="${base} ${cls}"
              onclick="marcarSerieEmIndice(${i}, ${n})"
              aria-label="S√©rie ${n}">
              ${n}
            </button>
          `;
        }).join("")
      : `<span class="text-xs text-red-300">inv√°lido</span>`;

    const canTrocar = (e.feitas === 0) && ((e.alternativas || []).length > 0);
    const btnTrocar = canTrocar
      ? `<button onclick="abrirModalTroca(${i})" class="rounded-xl px-3 py-2 bg-slate-800 text-xs font-semibold">Trocar</button>`
      : `<button class="rounded-xl px-3 py-2 bg-slate-900 border border-slate-800 text-xs font-semibold text-slate-400" disabled>Trocar</button>`;

    const borda = i === 0 ? "" : " border-t border-slate-800";

    host.innerHTML += `
      <div class="px-3 py-3 bg-slate-900${borda}">
        <div class="flex items-start justify-between gap-3">
          <div class="min-w-0">
            <div class="font-medium truncate">
              ${esc(ativo.nome)}
              ${badgeAlt}
              ${badgeB}
              ${concluido ? `<span class="ml-2 text-[10px] px-2 py-1 rounded-full bg-green-500/15 text-green-300 border border-green-500/25">conclu√≠do</span>` : ``}
            </div>
            <div class="text-xs ${invalido ? "text-red-300" : "text-slate-500"} mt-1">${esc(sub)}</div>
          </div>

          <div class="shrink-0 flex flex-col items-end gap-2">
            ${btnTrocar}
            ${(e.feitas===0 && e.altObrigatorio && (e.alternativas||[]).length>0) ? `
              <button onclick="abrirModalTroca(${i})" class="rounded-xl px-3 py-2 bg-pinkshock text-xs font-semibold">
                plano a indispon√≠vel
              </button>
            ` : ``}
          </div>
        </div>

        <div class="mt-3 flex gap-2 flex-wrap justify-end">
          ${bolinhas}
        </div>
      </div>
    `;
  });
}

function renderCardioExec(){
  const box = document.getElementById("boxCardioExec");
  const lista = document.getElementById("listaCardioExec");

  if(!temCardioValido(treinoAtual)){
    box.classList.add("hidden");
    lista.innerHTML = "";
    return;
  }

  box.classList.remove("hidden");
  const items = (treinoAtual.cardio.items || []).filter(i=>i.duracaoSeg>0);
  lista.innerHTML = items.map(it => `
    <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3 flex justify-between">
      <div class="text-sm text-slate-200">${esc(it.tipo)}</div>
      <div class="text-sm text-slate-400">${formatar(it.duracaoSeg)}</div>
    </div>
  `).join("");
}

/* =========================
   A√á√ïES (EXERC√çCIOS)
========================= */
function marcarSerieEmIndice(exIdx, serieNumero){
  const e = treinoAtual.exercicios[exIdx];
  const ativo = getAtivo(e);

  if(!ativo.series || !ativo.reps){
    alert("Esse exerc√≠cio est√° inv√°lido. Volte e corrija o formato (ex: 2x10).");
    return;
  }

  const feitasAntes = e.feitas;

  if(serieNumero <= e.feitas){
    e.feitas = Math.max(0, serieNumero - 1);
    renderExecucao();
    return;
  }

  e.feitas = Math.min(ativo.series, serieNumero);

  const feitasDepois = e.feitas;

  const avancou = feitasDepois > feitasAntes;
  const concluiuExercicio = feitasDepois >= ativo.series;

  if(concluiuExercicio){
    pularDescanso();
  } else if(avancou && ativo.descanso){
    iniciarDescanso(ativo.descanso);
  }

  renderExecucao();
}

/* =========================
   RESUMO FINAL + FINALIZAR
========================= */
function abrirResumo(inicioMs, fimMs, duracaoSeg){
  const ini = formatarDataHora(inicioMs);
  const fim = formatarDataHora(fimMs);

  document.getElementById("resumoDuracao").textContent = formatar(duracaoSeg);
  document.getElementById("resumoInicio").textContent = ini.hora;
  document.getElementById("resumoFim").textContent = fim.hora;

  if(ini.data === fim.data){
    document.getElementById("resumoData").textContent = `Data: ${ini.data}`;
  } else {
    document.getElementById("resumoData").textContent = `In√≠cio: ${ini.data} ‚Ä¢ Fim: ${fim.data}`;
  }

  const box = document.getElementById("boxResumoTrocas");
  const list = document.getElementById("resumoTrocasLista");
  if(sessionSwaps.length){
    box.classList.remove("hidden");
    list.innerHTML = sessionSwaps.map(s=>{
      const mot = s.motivo ? `<span class="text-slate-400">‚Ä¢ ${esc(s.motivo)}</span>` : `<span class="text-slate-500">‚Ä¢ sem motivo</span>`;
      return `
        <div class="rounded-xl border border-slate-800 bg-slate-950/30 p-3">
          <div class="text-sm text-slate-200">${esc(s.planejado)} ‚Üí <span class="text-pinkshock font-semibold">${esc(s.executado)}</span></div>
          <div class="text-xs text-slate-400 mt-1">${mot}</div>
        </div>
      `;
    }).join("");
  } else {
    box.classList.add("hidden");
    list.innerHTML = "";
  }

  mostrar("telaResumo");
}

function finalizar(){
  clearInterval(totalInterval);
  clearInterval(descansoInterval);
  clearInterval(cardioInterval);

  pularDescanso();
  resetCardioState();

  const fimMs = agoraMs();
  const inicioMs = treinoInicioMs ?? (fimMs - (totalSegundos * 1000));
  const duracaoSeg = totalSegundos;

  sessionEndMs = fimMs;

  let treinos = normalizarTreinos(getTreinos());
  treinos = removerTreinosExpirados(treinos).filtrados;

  if(typeof treinoAtualIndex === "number" && treinos[treinoAtualIndex]){
    treinos[treinoAtualIndex].stats.feitos = (treinos[treinoAtualIndex].stats.feitos || 0) + 1;
    treinos[treinoAtualIndex].stats.ultimaVezMs = fimMs;
    treinos[treinoAtualIndex].lastSession = { inicioMs, fimMs, duracaoSeg };
    treinos[treinoAtualIndex].lastSessionSwaps = sessionSwaps;

    // registra para a semana (bolinhas)
    registrarSessaoTreino(treinos[treinoAtualIndex].nome, fimMs);
  }

  setTreinos(treinos);

  (treinoAtual.exercicios || []).forEach(e=>{
    e.feitas = 0;
    e.selectedAlt = 0;
  });

  abrirResumo(inicioMs, fimMs, duracaoSeg);
}

/* =========================
   SPA
========================= */
function mostrar(id){
  ["telaHome","telaCadastrar","telaVisualizar","telaExecucao","telaResumo"]
    .forEach(t=>document.getElementById(t).classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  setNav("home");
}

/* =========================
   BACKUP (EXPORT / IMPORT)
========================= */
function exportarBackup(){
  const dados = localStorage.getItem(KEY);
  if(!dados) return alert("Nada para exportar.");
  const blob = new Blob([dados],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "backup_treinos.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importarBackup(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = async () => {
    const file = input.files?.[0];
    if(!file) return;

    try{
      const text = await file.text();
      const data = JSON.parse(text);

      if(!Array.isArray(data)) {
        return alert("Arquivo inv√°lido: esperado um JSON com lista de treinos.");
      }

      let treinos = normalizarTreinos(data);
      treinos = removerTreinosExpirados(treinos).filtrados;

      localStorage.setItem(KEY, JSON.stringify(treinos));
      alert("Backup importado com sucesso!");
      renderHome();
      mostrar("telaHome");
    } catch(err){
      alert("N√£o consegui importar esse arquivo. Ele parece estar inv√°lido.");
    }
  };

  input.click();
}

function abrirMenuBackup(){
  const acao = prompt("Backup:\n1 = Exportar\n2 = Importar\n\nDigite 1 ou 2:");
  if(acao === "1") return exportarBackup();
  if(acao === "2") return importarBackup();
}

/* =========================
   APAGAR / EDITAR
========================= */
function apagarTreino(i){
  let treinos = normalizarTreinos(getTreinos());
  treinos = removerTreinosExpirados(treinos).filtrados;

  const t = treinos[i];
  if(!t) return;

  if(!confirm(`Apagar o treino "${t.nome}"?\n\nIsso n√£o tem como desfazer.`)) return;

  treinos.splice(i, 1);
  setTreinos(treinos);

  renderHome();
  mostrar("telaHome");
}

function abrirEdicaoTreino(i){
  let treinos = normalizarTreinos(getTreinos());
  treinos = removerTreinosExpirados(treinos).filtrados;
  setTreinos(treinos);

  const t = treinos[i];
  if(!t) return;

  editIndex = i;
  setModoCadastro(true);
  mostrar("telaCadastrar");

  document.getElementById("inputNome").value = t.nome || "";
  document.getElementById("inputDescricao").value = t.descricao || "";
  document.getElementById("inputInicio").value = t?.periodo?.inicio || "";
  document.getElementById("inputFim").value = t?.periodo?.fim || "";
  document.getElementById("inputRaw").value = exerciciosToRawPlanoA(t.exercicios || []);

  // cardio
  limparCardioCadastroUI();
  const items = (t?.cardio?.items || []).filter(x => Number(x?.duracaoSeg) > 0);
  if(t?.cardio?.enabled && items.length){
    setCardioCadastro(true);
    document.getElementById("listaCardioConfig").innerHTML = "";
    items.forEach(it=>{
      const min = Math.round((Number(it.duracaoSeg) || 0) / 60);
      addCardioRow(it.tipo || "Esteira", String(min));
    });
  } else {
    setCardioCadastro(false);
    limparCardioCadastroUI();
  }

  // alternativas (preenche e mostra se existir)
  altDraft = (t.exercicios || []).map((e)=>({
    ...e,
    altObrigatorio: !!e.altObrigatorio,
    altRaw: altsToRaw(e)
  }));
  altDraftDirty = false;

  renderAltDraft();

  const temAlgumaAlt = altDraft.some(d =>
    !!d.altObrigatorio || ((d.altRaw || "").trim().length > 0) || (Array.isArray(d.alternativas) && d.alternativas.length > 0)
  );

  const box = document.getElementById("boxAlternativasCadastro");
  if(temAlgumaAlt) box.classList.remove("hidden");
  else box.classList.add("hidden");
}

/* =========================
   EVENTOS
========================= */
document.getElementById("btnNovo").onclick = () => {
  mostrar("telaCadastrar");
  editIndex = null;
  setModoCadastro(false);

  document.getElementById("inputNome").value = "";
  document.getElementById("inputDescricao").value = "";
  document.getElementById("inputInicio").value = "";
  document.getElementById("inputFim").value = "";
  document.getElementById("inputRaw").value = "";

  setCardioCadastro(false);
  limparCardioCadastroUI();

  limparAlternativasCadastro();
};

document.getElementById("btnCancelar").onclick = () => {
  editIndex = null;
  setModoCadastro(false);
  mostrar("telaHome");
  renderHome();
};
document.getElementById("btnVoltarHome").onclick = () => {
  mostrar("telaHome");
  renderHome();
};
document.getElementById("btnIniciar").onclick = iniciarExecucao;
document.getElementById("btnFinalizar").onclick = finalizar;

document.getElementById("btnPularDescanso").onclick = pularDescanso;

document.getElementById("btnVoltarResumo").onclick = () => {
  renderHome();
  mostrar("telaHome");
};

document.getElementById("navHome").onclick = () => {
  setNav("home");
  mostrar("telaHome");
  renderHome();
};

document.getElementById("navBackup").onclick = () => {
  setNav("backup");
  abrirMenuBackup();
};

/* modal troca */
document.getElementById("btnFecharModalTroca").onclick = fecharModalTroca;
document.getElementById("modalTroca").addEventListener("click", (ev)=>{
  if(ev.target.id === "modalTroca") fecharModalTroca();
});

/* cardio cadastro events */
document.getElementById("btnCardioSim").onclick = () => setCardioCadastro(true);
document.getElementById("btnCardioNao").onclick = () => setCardioCadastro(false);
document.getElementById("btnAddCardio").onclick = () => addCardioRow("Esteira","");

/* cardio execu√ß√£o events */
document.getElementById("btnAbrirCardioTimer").onclick = () => abrirCardioTimer();
document.getElementById("btnCardioPlayPause").onclick = toggleCardioPlayPause;
document.getElementById("btnPularCardio").onclick = pularCardioAtual;

/* alternativas cadastro events */
document.getElementById("btnConfigAlternativas").onclick = abrirConfigAlternativas;
document.getElementById("btnFecharAlternativas").onclick = () => {
  document.getElementById("boxAlternativasCadastro").classList.add("hidden");
};
document.getElementById("btnLimparAlternativas").onclick = () => {
  if(confirm("Limpar todas as alternativas configuradas neste cadastro?")){
    limparAlternativasCadastro();
    alert("Alternativas limpas.");
  }
};

document.getElementById("inputRaw").addEventListener("input", ()=>{
  altDraftDirty = true;
});

/* salvar (novo ou editar) */
document.getElementById("btnSalvar").onclick = () => {
  const nome = document.getElementById("inputNome").value.trim();
  const descricao = document.getElementById("inputDescricao").value.trim();
  const inicio = document.getElementById("inputInicio").value || null;
  const fim = document.getElementById("inputFim").value || null;
  const raw = document.getElementById("inputRaw").value.trim();

  if(!nome || !raw) return alert("Preencha o nome e os exerc√≠cios.");

  if(inicio && fim){
    const iniMs = new Date(inicio + "T00:00:00").getTime();
    const fimMs = fimDoDiaMsFromISO(fim);
    if(iniMs > fimMs) return alert("A data de in√≠cio n√£o pode ser depois da data final.");
  }

  let exercicios = parseLinhas(raw);
  const invalidos = exercicios.filter(e => !e.series || !e.reps);
  if(invalidos.length){
    return alert("Tem exerc√≠cio sem s√©ries/reps no formato NxM (ex: 2x10). Corrija antes de salvar.");
  }

  // aplica alternativas do draft
  if(altDraft.length){
    try{
      exercicios = aplicarAlternativasNoPlanoA(exercicios);
    } catch(err){
      const msg = String(err?.message || "");
      if(msg.startsWith("ALTS_INVALIDAS::")){
        const linhas = msg.replace("ALTS_INVALIDAS::","").trim();
        return alert("Tem alternativa com s√©ries/reps inv√°lidos (precisa NxM). Corrija estas linhas:\n\n" + linhas);
      }
      return alert("Erro ao aplicar alternativas. Tente abrir ‚ÄúConfigurar alternativas‚Äù de novo.");
    }
  }

  const faltando = validarAltObrigatorias(exercicios);
  if(faltando.length){
    return alert("Plano B obrigat√≥rio sem alternativas em:\n\n- " + faltando.join("\n- ") + "\n\nAbra ‚ÄúConfigurar alternativas‚Äù e adicione pelo menos 1 linha.");
  }

  const cardio = coletarCardioDoCadastro();

  let treinos = normalizarTreinos(getTreinos());
  treinos = removerTreinosExpirados(treinos).filtrados;

  const payload = {
    nome,
    descricao,
    periodo: { inicio, fim },
    exercicios,
    cardio,
    stats: { feitos: 0, ultimaVezMs: null }
  };

  if(typeof editIndex === "number" && treinos[editIndex]){
    // preserva stats antigas
    payload.stats = treinos[editIndex].stats || { feitos: 0, ultimaVezMs: null };
    payload.lastSession = treinos[editIndex].lastSession || null;
    payload.lastSessionSwaps = treinos[editIndex].lastSessionSwaps || [];
    treinos[editIndex] = payload;
  } else {
    treinos.push(payload);
  }

  treinos = removerTreinosExpirados(treinos).filtrados;
  setTreinos(treinos);

  editIndex = null;
  setModoCadastro(false);
  limparAlternativasCadastro();

  renderHome();
  mostrar("telaHome");
};

/* =========================
   INIT
========================= */
renderHome();
setNav("home");
atualizarUI_Descanso();

setCardioCadastro(false);
limparCardioCadastroUI();
</script>

</body>
</html>
